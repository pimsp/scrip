\documentclass[12pt]{article}

\usepackage{graphicx}
%\pagestyle{empty}
\usepackage{dsfont}
\usepackage{textcomp}
\usepackage{amsmath}
\usepackage{courier}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\graphicspath{{images/}}
\usepackage{amsthm}
\usepackage{eucal}
\usepackage{amssymb}
%\usepackage{mdsymbol}
\usepackage{mathrsfs}
\usepackage{dsfont}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\usepackage{caption}
\usepackage{tikz}
\usepackage{tikz-cd}
\usepackage{wrapfig,lipsum,booktabs}
\usepackage{caption}
\usepackage[square, longnamesfirst,numbers]{natbib}
\usepackage[ruled,linesnumbered]{algorithm2e}
\usepackage{todonotes}
\usepackage[all]{nowidow}

%\usepackage{hyperref}
\usepackage{amstext} % for \text macro
\usepackage{array}   % for \newcolumntype macro
\usepackage[unicode]{hyperref}
\usepackage{verbatim}
\usepackage{makecell}
\usepackage{float}
\usepackage{mathtools}

\newcolumntype{C}{>{$}c<{$}} % math-mode version of "l" column type

\relpenalty=10000
\binoppenalty=10000

\newcommand{\den}{\mathop{\mathgroup\symoperators den}\nolimits}
\newcommand{\ggd}{\mathop{\mathgroup\symoperators ggd}\nolimits}
\newcommand{\des}{\text{d.e.s.d.a.\ }}
%\newcommand{\opg}{\text{d.e.s.d.a.\ }}
\newcommand{\blokje}{\hfill $\Box$\\}
%Om je bewijs of je antwoord af te sluiten.
\newcommand{\header}[1]{\vspace{0.5cm}\framebox[\linewidth]{\textsc{Exercise #1}}\\}
\newcommand{\deel}[1]{\textbf{#1)}\ }
\newcommand{\macht}[1]{\mathcal{P}(#1)}
\newcommand{\entier}[1]{\left\lfloor #1 \right\rfloor}
\newcommand{\A}{\mathbb{A}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\renewcommand{\G}{\mathbb{G}}
\renewcommand{\C}{\mathbb{C}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\Fcal}{\mathcal{F}}
\newcommand{\Lcal}{\mathcal{L}}
\renewcommand{\O}{\mathcal{O}}
\renewcommand{\P}{\mathbb{P}}
\newcommand{\Pcal}{\mathcal{P}}
\newcommand{\NP}{\mathcal{NP}}
\newcommand{\NPC}{\mathcal{NPC}}
\newcommand{\F}{\mathbb{F}}
\renewcommand{\angle}[1]{\hspace{-2pt}\left\langle #1 \right\rangle}
\newcommand*\diff{\mathop{}\!\mathrm{d}}
\newcommand{\rad}{\text{rad}}
\newcommand{\x}{x}
\newcommand{\m}{\mathfrak{m}}
\newcommand{\tensor}{\otimes}
\newcommand{\Ring}{\textbf{Rings}}
\newcommand{\Sets}{\textbf{Sets}}

\DeclareMathOperator{\mon}{mon}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\trdeg}{trdeg}
\DeclareMathOperator{\rk}{rk}
\DeclareMathOperator{\Fun}{Fun}
\DeclareMathOperator{\im}{im}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\sm}{sm}
\DeclareMathOperator{\pr}{pr}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\MaxSpec}{MaxSpec}
\DeclareMathOperator{\Spf}{Spf}
\DeclareMathOperator{\sep}{sep}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\GL}{GL}
\DeclareMathOperator{\Mat}{Mat}
\let\S\undefined
\DeclareMathOperator{\S}{S}
\let\div\undefined
\DeclareMathOperator{\div}{div}

\frenchspacing

\begingroup
\makeatletter
\@for\theoremstyle:=definition,remark,plain\do{%
	\expandafter\g@addto@macro\csname th@\theoremstyle\endcsname{%
		\addtolength{\thm@preskip}{5pt}
		\setlength{\thm@postskip}{10pt}
	}%
}
\endgroup %Zorgt voor mooie enters voor claims


\title{A geometric approach to linear and quadratic Chabauty}
\author{Pim Spelier}
\date{November 2015}

%\newtheoremstyle{mytheoremstyle}{5pt}{-15pt}{\itshape}{}{\bfseries}{.}{.5em}{} 

\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section] % reset theorem numbering for each section
\newtheorem{lem}[thm]{Lemma} % same for lemma's
\newtheorem{conj}[thm]{Conjecture} % same for vermoedens
\newtheorem{cor}[thm]{Corollary} % same for vermoedens
\newtheorem{prop}[thm]{Proposition} % same for vermoedens
\newtheorem{algo}[thm]{Algorithm} % same for vermoedens

\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition} % definition numbers are dependent on theorem numbers
\newtheorem{exmp}[thm]{Example} % same for example numbers

\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark} % remark numbers are dependent on theorem numbers

\usepackage{chngcntr}
\counterwithin{table}{section}

\newcommand{\overbar}[1]{\overline{#1}}

%\setlength{\parindent}{0pt}
%\setlength{\parskip}{\baselineskip}

\newcommand\legendre[2]{
  \genfrac(){}{}{#1}{#2}
}

\newcommand{\ord}{\operatorname{ord}}

\begin{document}
%\nocite{*}

\vspace*{1em}

\begin{center}

{\Large\bf 
P.\ Spelier
} 

\vspace{1em} 

{\LARGE\bf 
A geometric approach to linear Chabauty
} 

\vspace{10em} 

{\large\bf 
Master thesis
} 

\vspace{1em}

{\large\bf 
\today
}

\vspace{10em} 

{\large\bf
\begin{tabular}{ll}
Thesis supervisor: & prof. dr. S.J. Edixhoven\\
\end{tabular}
}

\vfill

\includegraphics{ulzegel_blauw}\\

\vspace{2em}

{\large\bf 
Leiden University\\
Mathematical Institute\\
}

\end{center}
\thispagestyle{empty}
\newpage
\listoftodos
\tableofcontents
\newpage

%-----------------------------------------------------------------------------------------------------------------------
\todo{Remove overfull h-box warnings}\todo{Referentie naar een artikel van Balakrishnan en Dogra, en Besser.}
\section{Introduction}
\label{section:intro}
In mathematics a fundamental problem is solving polynomial equations over the rationals, dating back to Diophantus. An important special case in algebraic geometry is that of curves. The behavior of the rational points of curves depends enormously on the \textit{genus} $g$ of the curve $C$, a numerical invariant of a curve. For $g = 0$, there are either no or infinitely many solutions, and their behavior is well understood. For $g = 1$, we get either no point or an elliptic curve, whose set of rational points forms an often infinite group.

In this thesis, we look only at the case $g > 1$. It turns out that there are always only finitely many rational points; this result was originally conjectured by Mordell in 1922 and finally proven by Faltings in 1983.

Before it was proven, one of the major partial results was a theorem from Chabauty in 1941, phrased in terms of the rank $r$ of the group of rational points on the Jacobian $J$ of the curve, also called the Mordell-Weil rank, which is finite by the Mordell-Weil theorem. Chabauty proved, using $p$-adic methods, that if $r$ is strictly smaller than the genus $g$, then $C$ has only finitely many rational points. Loosely said, this proof and all Chabauty related theorems, rely on choosing a prime $p$ for which $C$ has good reduction, and intersecting $J(\Z)$ with $C(\Z_p)$ inside the bigger Lie group $J(\Z_p)$; by properties of $\Z_p$, the subgroup $J(\Z)$, generated by $r$ elements, lies within a Lie subgroup of dimension at most $r$, and $C(\Z_p)$ is a $1$-dimensional $p$-adic manifold, and hence their intersection can be proven to be discrete and -- as $J(\Z_p)$ is compact -- finite.

This was later made into an effective argument by Coleman in 1985. This was done by finding explicitly, as a power series, a differential form $\omega$ on $J_{\Z_p}$ whose Coleman integral vanishes on $J(\Z)$. Pulling $\omega$ back to $C_{\Z_p}$ and looking at the fibre of reduction to a single $\F_p$-point $P$, one can in certain cases give an upper bound for the number of points in $C(\Z)$ reducing to $P$ based only on finite-precision calculations of $\omega$. Most well known is the generic upper bound $|C(\Q)| \leq |C(\F_p)| + 2g-2$ under the conditions $r < g, p > 2g$, as explained in the introductory article \cite{poonen12}.

This Coleman-Chabauty method has been greatly generalised by Kim to so called non-abelian Chabauty. He interprets working in the Jacobian as dealing with the abelianised fundamental group of the curve $C$, and works with larger, non-abelian quotients of the fundamental group. Using quadratic Chabauty, the simplest case of non-abelian Chabauty, Balakrishnan, Dogra, M\"uller, Tuitman and Vonk in 2017 famously calculated  all rational points of the ``cursed curve'', the modular curve $X_s^+(13)$ \cite{cursedcurve}. They use an endomorphism of the Jacobian, and do $p$-adic analysis on $p$-adic local heights to make quadratic Chabauty explicit. 

Very recently, Edixhoven and Lido made available a preprint of their article ``Geometric quadratic Chabauty'' \cite{edixhoven20}. Their goal in this article is to make a more geometric approach to effective quadratic Chabauty, by working in a pullback $T$ of the Poincar\'e torsor of the Jacobian. They also abandon the Coleman method for Chabauty; instead they parametrise the map $T(\Z) \to T(\Z_p)$ with power series, and pull back equations for the curve inside $T(\Z_p)$ along this map. 

The purpose of this thesis is to make the work by Edixhoven and Lido more accessible by applying geometric Chabauty to the linear case, i.e. when working with $J(\Z)$ and $J(\Z_p)$. In this thesis, we go into more detail of what is happening throughout the process, including both theoretical and practical components. This new method of applying Chabauty leads to, when working modulo $p$, a conditional upper bound $|C(\Q)| \leq |C(\F_p)|$, as obtained in Proposition~\ref{prop:linchabauty}. This upper bound compares favorably with classical Coleman-Chabauty, but unlike classical Coleman-Chabauty, we cannot say in general when the conditions of these propositions hold. We develop heuristics that suggest that generally trying multiple primes $p$ of good reduction will yield good results; these heuristics say that the conditional upper bound will hold for a set of primes of density $1$, and if $r < g-1$ can even often (in a set of primes of density $e^{-1}$) be improved to prove there are at most $|C(\Q)|$ rational points\todo{Bas, dit is denk ik de beste samenvatting}. The methods used to obtain Proposition~\ref{prop:linchabauty} are also amenable to higher precision calculations. We also give a hyperelliptic example with $r = 1, g = 2$, where the bound from Proposition~\ref{prop:linchabauty} indeed holds. 

\subsection{Overview}
We first present the context in which we will perform Chabauty. Let $p>2$ be a prime, and $C$ be a scheme over $\Z$, proper, flat, regular with $C$ smooth over $\Z_{(p)}$ and $C_\Q$ of dimension $1$ and geometrically connected, of genus $g \geq 1$ and with the Jacobian $J$ of $C$ having Mordell-Weil rank $r < g$. Assume we have a $\Q$-point $b$ in $C$, or equivalently a $\Z$-point. We view $C$ as a subscheme of $J$, using the map $Q \mapsto Q - b$ on points. Let $P \in C(\F_p)$ be a point such that $t := P - b \in J(\F_p)$ lies in the image of $J(\Z)$.

\begin{defn}
Let $S$ be a scheme, $T \to U$ a morphism of schemes and $x : T \to S$ a $T$-point. We define $S(U)_x$ as the morphisms from $U$ to $S$ that, after precomposing with $T \to U$, give $x$.
\end{defn}
\begin{exmp}
If we have a projective variety $X$ over $\Z$, then $X(\Z)$ is in bijection with $X(\Q)$. The natural map $X(\Z) \to X(\F_p)$ reduces a point modulo $p$ and for $x \in X(\F_p)$, the set $X(\Z)_x$ consists of the $\Z$-points reducing to $x$.
\end{exmp}

Geometric chabauty works by finding an upper bound for the cardinality of $C(\Z)_P$. For this, we use the following diagram.
\[
\begin{tikzcd}
C(\Z)_P \arrow[d] \arrow[r, "a"] & J(\Z)_t \arrow[d] \\
C(\Z_p)_P \arrow[r]              & J(\Z_p)_t        
\end{tikzcd}
\]
where the two vertical maps are inclusions, and the two horizontal maps are subtraction of $b$. We will in fact compute upper bounds for the larger set $C(\Z_p)_P \cap \overline{J(\Z)_t}$, where $\overline{J(\Z)_t}$ is the closure of $J(\Z)_t$ in $J(\Z_p)_t$. 

In Section~\ref{section:smoothzppoints}, we treat the structure of $C(\Z_p)_P$ and $J(\Z_p)_t$; we will show that, after choosing parameters, they are canonically in bijection with respectively $\Z_p$ and $\Z_p^g$. We also discuss the resulting map $\Z_p \to \Z_p^g$.

In Section~\ref{section:kappa} we further look at the map $J(\Z)_t \to J(\Z_p)_t$. This is a translation of the group morphism $J(\Z)_0 \to J(\Z_p)_0$ between kernels of reduction; it turns out that for our choice of $p$, the subgroup $J(\Z)_0$ is free of rank $r$. We study the properties of the resulting map $\Z^r \to \Z_p^g$, using the theory of formal groups to determine the group structure on $\Z_p^g$ induced by the bijection $J(\Z_p)_t \to \Z_p^g$.

In Section~\ref{section:intersection}, we put all of this information together, culminating in several methods to possibly compute upper bounds on $\left|C(\Z_p)_P \cap \overline{J(\Z)_t}\right|$ with finite precision calculations. We also perform a heuristic analysis to show that a simple calculation of linear algebra modulo $p$ is very likely to result in an upper bound of at most $|C(\F_p)|$ for $|C(\Z)|$, and for $r < g-1$ even in an upper bound of $|C(\Z)|$.

The methods developed in the first four sections are not always guaranteed to prove finiteness of $C(\Z)_P$. In Section~\ref{section:remarks} we treat several possible complications and improvements, referring to other work on Chabauty for further reading.

Next, in Section~\ref{section:explicit} we focus on how to perform the calculations happening in the Jacobian. Here, we use Makdisi's approach of representing a divisor by a subspace of a large Riemann-Roch space. We partially follow the article \cite{mascot18} by Mascot, and also give an original algorithm for explicitly computing the map $C(\Z_p)_P \to J(\Z_p)_t$ in Makdisi's representation.

We end our discussion of linear geometric Chabauty with an explicit example in Section~\ref{section:example}, a genus $2$ curve whose Jacobian has Mordell-Weil rank $1$. We use both Magma and Pari/GP to do our calculations, and end up with a complete list of all rational points of the curve.

Finally, we provide an introduction to geometric quadratic Chabauty in Section~\ref{section:quadratic}. Here, we aim to introduce all the different objects relevant to geometric quadratic Chabauty; we explain why we have to work over $\Z$ instead of over $\Q$ to make geometric quadratic Chabauty make sense; and we explain some of the problems and solutions that working over $\Z$ gives rise to.

\subsection{Preliminaries}\todo{Bas, dit en het volgende stukje zijn nieuw}
We expect the readers of this thesis to be familiar with algebraic geometry, e.g. master students with a specialisation in algebraic geometry. The introduction to geometric quadratic Chabauty in Section~\ref{section:quadratic} contains some terms typically not treated in a master; while knowing them will help put the material in context, this section is meant to be understandible even if that is not the case. \todo{Bas, nog een specifieke referentie voor voorkennis die ik op kan nemen, of niet per se?}

\subsection{Acknowledgements}
I would like to thank my supervisor Bas Edixhoven for his help --- I have learnt a great deal since starting on this thesis, and he helped me do so. I would also like to thank my father, for all the support he has shown me.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
% Say something about smooth schemes over Z_p, and their Z_p points
\section{Points on a smooth scheme over \texorpdfstring{$\Z_p$}{Z\_p}}
\label{section:smoothzppoints}
Let $X/\Z_p$ be a smooth scheme of relative dimension $d$, and let $x \in X(\F_p)$ be a point. Then $X(\Z_p)_x$ is in bijection with $\Z_p^d$. This bijection is given by choosing parameters at $x$; evaluating at $X(\Z_p)_x$ gives a bijection with $(p\Z_p)^d$, and then we divide by $p$. For putting up a nice framework to work in, we start with blowing up $X$ at $x$.

% Blow up X at x, and look at the part where p generates the maximal ideal
Assume, by looking at a neighborhood of $x$, that $X = \Spec A$ is affine and that $p,t_1,\dots,t_d$ generate the maximal ideal of $O_{X,x}$ with $t_1,\dots,t_d$ elements of $O_X(X) = A$, also called \textit{parameters} at $x$. By shrinking $X$ even more, we may assume as $X$ is smooth that $t = (t_1,\dots,t_d): X \to \A^d_{\Z_p}$ is \'etale. Now consider the blowup $\widetilde{X}_x \to X$ of $X$ at $x$, and let $\widetilde{X}_x^p$ be the part where $p$ generates the inverse image of the maximal ideal of $O_{X,x}$. Equivalently, that is the part where $t_1,\dots,t_d$ are multiples of $p$, so informally it consists of the points that reduce to $x$ modulo $p$.

There is an explicit description of the map $\widetilde{X}_x^p \to X$; as $t$ is \'etale, the ideal of $X$ defining $x$ is the pullback along $t$ of the ideal of $\A^d_{\Z_p}$ defining the origin $a$ over $\F_p$. That means that the blowup $\widetilde{X}_x \to X$ is the pullback of the blowup $\widetilde{\A}^d_{\Z_p,a} \to \A_{\Z_p}^d$. Then the part $\widetilde{X}_x^p$ is the pullback of the corresponding part of $\widetilde{\A}^d_{\Z_p,a}$, i.e. $\Spec \Z_p[\widetilde{x_1},\dots,\widetilde{x_d}] = \Spec \Z_p[x_1/p,\dots,x_d/p]$ with the morphism $\Z_p[x_1,\dots,x_d] \to \Z_p[\widetilde{x_1},\dots,\widetilde{x_d}]$ given by $x_i \mapsto p\widetilde{x_i}$. That implies that $\widetilde{X}_x^p$ is $\Spec A[t_1/p,\dots,t_d/p]$, with the map $\widetilde{X}_x^p \to X$ given by the inclusion $A \to \Spec A[t_1/p,\dots,t_d/p]$ (remember that the $t_i$ are elements of $O_X(X) = A$).

This now enables us to characterise explicitly the $\Z_p$-points above $x$, as in the following two lemmas.

\begin{lem}
With $X$ as above, there is a natural bijection $X(\Z_p)_x \to \widetilde{X}_x^p(\Z_p)$,
\end{lem}
\begin{proof}
Note that by (I,2.4.4) of \cite{ega}, a $\Z_p$-point of a scheme $S$ is just an $\F_p$-point $s$ together with a local morphism $\O_{S,s} \to \Z_p$. In our case, we find that $X(\Z_p)_x$ is naturally in bijection with $\Hom_{\text{local}}(A_x,\Z_p)$. As the maximal ideal of $A_x$ is generated by $p,t_1,\dots,t_d$, the locality property just means that the images of $t_1,\dots,t_d$ are divisible by $p$, i.e. exactly those morphisms that extend to a morphism $A[t_1/p,\dots,t_d/p] \to \Z_p$, i.e. a $\Z_p$-point of $\widetilde{X}_x^p$. Hence we find the natural bijection.
\end{proof}

\begin{lem}
With $X$ as above, evaluating $t$ at $X(\Z_p)_x$ gives a bijection to $(p\Z_p)^d$.
\end{lem}
\begin{proof}
As $t$ is locally of finite type, by (IV,17.6.3) of \cite{ega} we have an isomorphism between the $p$-adic completion $O(\widetilde{X}_x^p)^{\wedge p}$ and the completion $\Z_p\angle{\widetilde{x_1},\dots, \widetilde{x_d}}$ of $\Z_p[\widetilde{x_1},\dots,\widetilde{x_d}]$, with the latter completion being the ring of convergent power series, i.e.
\[
\Z_p\angle{\widetilde{x_1},\dots, \widetilde{x_d}} = \left\{f \in \Z_p[[\widetilde{x_1},\dots,\widetilde{x_d}]] \mid \forall n \geq 0, f \in \Z[\widetilde{x_1},\dots,\widetilde{x_d}] + (p^n) \right\}.
\]
By the universal property of completions, as $t$ induces the isomorphism between completions, $t$ also induces a bijection $$\Hom(O(\widetilde{X}_x^p), \Z_p) \to \Hom(\Z_p\angle{\widetilde{x_1},\dots,\widetilde{x_d}},\Z_p) = \Z_p^d.$$ Following all the bijections, we indeed get the bijection we wanted.
\end{proof}

\begin{rem}
\label{rem:smoothpointsfunc}
Note that this construction is functorial, as in the following sense: given two smooth schemes $X,Y$ over $\Z_p$ and two $\F_p$-points $x\in X(\F_p)$, $y\in Y(\F_p)$, a map $f: Y \to X$ satisfying $f(y) = x$ gives rise to a morphism $\widetilde{Y}_y^p \to \widetilde{X}_x^p$. This is a direct consequence of II.7.15 of \cite{hartshorne}.
\end{rem}

\todo{Volgend stukje is nieuw, en het stukje erna is iets herschreven}\begin{rem}
\label{rem:torsortangentspace}
In actual calculations, we will be focusing on $X(\Z/p^2\Z)_x$. This set is a natural torsor of the tangent space $T_x X_{\F_p}$ of $X_{\F_p}$ at $x$, which we will describe here. We write $R$ for the local ring $O_{X_{\Z/p^2\Z},x}$ and $\m$ for its maximal ideal, and $\overline{R}$ and $\overline{m}$ for their reductions modulo $p$. Then an element in $X(\Z/p^2\Z)_x$ is a local morphism $R \to \Z/p^2\Z$. As $R/\m = \F_p$, giving such a local morphism is equivalent to giving a map $\m \to p\Z/p^2\Z$ respecting multiplication and sending $p$ to $p$. Such a map factors uniquely through $\m/\m^2 \to p\Z/p^2\Z$. We see the set $X(\Z/p^2\Z)_x$ is canonically in bijection with $\F_p$-linear maps $\m/\m^2 \to p\Z/p^2\Z$ sending $p$ to $p$. Note that $\m/\m^2$ is a $d+1$-dimensional $\F_p$-vector space, and $\overline{\m}/\overline{\m}^2$ is a $d$-dimensional vector space; the map $\m/\m^2 \to \overline{\m}/\overline{\m}^2$ is dividing out by $p$. Denoting ${}^\wedge$ to be $\Hom(\cdot,\F_p)$, the exact sequence
\[
0 \to p\Z/p^2\Z \to \m/\m^2 \to \overline{\m}/\overline{\m}^2 \to 0
\]
can be dualised to
\[
0 \to (\overline{\m}/\overline{\m}^2)^\wedge \to (\m/\m^2)^\wedge \to (p\Z/p^2\Z)^{\wedge} \to 0.
\]
As $X(\Z/p^2\Z)_x$ is exactly the subset of $(\m/\m^2)^\wedge$ that gets mapped to $p \mapsto 1 \in (p\Z/p^2\Z)^{\wedge}$, we see this is naturally a torsor under $(\overline{\m}/\overline{\m}^2)^\wedge = T_{x} X_{\F_p}$.

Note that this set does not have any more canonical structure; for example, with $X = \A^1_{\Z_p}$ and $x$ is the $\F_p$-point $1$, the set $X(\Z/p^2\Z)_x$ is $\{1 + pi | i \in \F_p\}$, and we see we cannot upgrade the torsor structure. This is due to the fact that even after choosing a parameter at $x$ as a point of $X_{\F_p}$, a lift of such a parameter to $X_{\Z/p^2\Z}$ is not unique, and can in fact differ up to translation. This is in contrast to the situation over $\F_p[\varepsilon]/(\varepsilon^2)$, where the $\F_p$-algebra structure gives rise to an isomorphism of $\F_p$-vector spaces between $X(\F_p[\varepsilon]/(\varepsilon^2))$ and $T_x X_{\F_p}$; indeed, this is an alternate definition of the tangent space.
\end{rem}

\begin{rem}
\label{rem:cartierlinear}
We look at the specific case of $X$ being of relative dimension $1$ over $\Z_p$. Then the $T_x X_{\F_p}$-torsor structure on $X(\Z/p^2\Z)_x$ translates into something more concrete. We can parametrise $X(\Z/p^2\Z)_x$ by $t = t_1 : X(\Z/p^2\Z)_x \to p\Z/p^2\Z$; write $P_{\lambda}$ for the point with $t$-value $\lambda p$. Then as Cartier divisor, the point $P_{\lambda}$ is defined by $t - \lambda p \in O(X_{\Z/p^2\Z})_x$, so $P_{\lambda} + P_{\mu}$ is defined by $(t-\lambda p)(t-\mu p) = t^2 - (\lambda + \mu)tp$, which defines the same Cartier divisor as $P_{\lambda'} + P_{\mu'}$ if and only if $\lambda + \mu = \lambda' + \mu'$. In that case, as a Cartier divisor, $P_{\lambda} + P_{\mu}$ is in fact equal to $P_{\lambda'} + P_{\mu'}$.
\end{rem}

\subsection{From \texorpdfstring{$C(\Z_p)$}{C(Z\_p)} to \texorpdfstring{$J(\Z_p)$}{J(Z\_p)}}
\label{subsection:czptojzp}
We know that $C(\Z_p)_P$ is in bijection with $\Z_p$, again with the bijection given by evaluating a parameter and dividing by $p$. The resulting function $\Z_p \to \Z_p^g$ is linear modulo $p$, i.e. by using that $\Z\angle{z_1,\dots,z_g}$ is $p$-adically complete there are power series $f_1,\dots,f_{g-1} \in \Z_p\angle{z_1,\dots,z_g}$ such that the image of $C(\Z_p)_P$ is exactly given by $V(f_1,\dots,f_{g-1})$, and all $f_i$ are linear modulo $p$ as a consequence of Remark \ref{rem:cartierlinear}. Another way to think of this, is as $C(\Z/p^2\Z)_P$ being an affine line inside $J(\Z/p^2\Z)_t$. That $C(\Z/p^2\Z)_P$ is an affine line inside $J(\Z/p^2\Z)_t$ can also be seen more easily: this map can be identified with the tangent map, using the structure of $X(\Z/p^2\Z)_x$ as a torsor over the tangent space from \ref{rem:cartierlinear}.

\begin{rem}
\label{rem:fislinear}
We can pick our parameters such that $C(\Z_p)_P \to J(\Z_p)_t$ is given by $\Z_p \to \Z_p^g$, mapping $\Z_p$ to the last coordinate. Then $f_1,\dots,f_{g-1}$ are just the other parameters at $t$, so they are linear. This can be done by picking generators $f_1,\dots,f_{g-1}$ for the ideal defining $\widetilde{C}_P^p$ inside $\widetilde{J}_t^p$.
\end{rem}

\section{From \texorpdfstring{$J(\Z)$}{J(Z)} to \texorpdfstring{$J(\Z_p)$}{J(Z\_p)}}
\label{section:kappa}
For $p > 2$, we know that the torsion of $J(\Z)$ injects into $J(\F_p)$, by Proposition 2.3 of \cite{pierre2000}. Hence for $0 \in J(\F_p)$, we know $J(\Z)_0$ is as a group isomorphic to $\Z^r$ with $r$ the Mordell-Weil rank. By assumption, we also know $J(\Z)_t$ is in bijection with $J(\Z)_0$, with the bijection giving by translating with a lift of $t$. By Section \ref{section:smoothzppoints} we know $J(\Z_p)_t$ is in bijection with $\Z_p^{g}$, with the bijection given by evaluating parameters and dividing by $p$. Let $\kappa: \Z^r \to \Z_p^g$ be the map resulting from the inclusion $J(\Z)_t \to J(\Z_p)_t$. In this section we will prove that $\kappa$ turns out to have a special property.

\begin{thm}
\label{thm:kappanice}
There are uniquely determined $\kappa_1,\dots,\kappa_g \in \Z_p\angle{z_1,\dots,z_r}$ such that for all $x \in \Z^r$ we have $\kappa(x) = (\kappa_1(x),\dots,\kappa_g(x))$ and the image $\overline{\kappa_i}$ of $\kappa_i$ in $\F_p[z_1,\dots,z_r]$ has degree at most $1$; furthermore, for $m \in \Z_{>0}$ with $m<p-1$, these $\kappa_i$ are also of degree at most $m$ modulo $p^m$.
\end{thm}

We will prove this using results about formal group as defined in \cite{honda70}. To be able to use this theory, we first give some results about going from a group scheme over $\Z_p$ to a formal group.
First we introduce some notation that will be used in this section. Let $R$ be a commutative ring, and $x = (x_1,\dots,x_n)$ and sometimes $y,z$ are vectors of variables. Then $R[[x]]$ denotes as usual the ring of formal powerseries in the $x_i$, and $R[[x]]_0$ denotes those power series with constant term $0$. With $x = (x_1,\dots,x_n)$ and $y = (y_1,\dots,y_m$), let $f \in R[[x]]^m$ and assume $f(0) = 0$. Then for $g \in R[[y]]^k$ for some $k\in\Z_{\geq 0}$, we can compose $g$ and $f$ to get \[g\circ f := (g_1(f(x)),\dots,g_k(f(x)))\in R[[x]]]^k.\] This definition makes sense because $f^i$ converges to $0$, so the infinite sum $g_j(f(x))$ converges.

\subsection{From group schemes to formal groups}
We first recall the definition of a formal group. For this entire section, $R$ is a ring, and $x,y,z$ are vectors of variables.
\begin{defn}
\label{defn:formalgroup}
Let $n$ be a non-negative integer. Let $x,y,z$ be vectors of $n$ variables. An $n$-dimensional formal group is an element $F = (F_1,\dots,F_n)$ of $R[[x,y]]_0^n$ satisfying $F \equiv x + y \bmod (x,y)^2$ and $F(F(x,y),z) = F(x,F(y,z))$. If furthermore $F(x,y) = F(y,x)$, this formal group is said to be commutative.
\end{defn}
\begin{exmp}
\label{exmp:ganformalgroup}
For any $n$, we can take $F(x,y) = x+ y$, also known as the $n$-dimensional additive formal group.
\end{exmp}
\begin{exmp}
\label{exmp:gmformalgroup}
Take $n=1$ and $F(x,y) = x + y + xy = (1+x)(1+y)-1$, also known as the multiplicative formal group, as it is a translation of the natural multiplication on $1 + xR[x]$. This satisfies associativity by the formula \[F(F(x,y),z) = (1+x)(1+y)(1+z)-1 = F(x,F(y,z)).\]
\end{exmp}
Note there is no mention of an inverse; the following lemma, a formal version of the implicit function theorem, tells us that the inverse follows automatically from the definitions.
\begin{lem}
\label{lem:implicitfunction}
Let $x,y$ be vectors of variables of length $n$. Let $F \in R[[x,y]]_0^n$ such that $F \equiv Ax + By \bmod (x,y)^2$ with $A \in \Mat_n(R)$ and $B \in \GL_n(R)$. Then there is a unique $\iota \in R[[x]]_0^n$ such that $F(x,\iota(x)) = 0$. 
\end{lem}
\begin{proof}
If $F$ is a polynomial, this is a special case of a multivariate version of Hensel's lemma, as in Corollaire~2 of \cite[III,4.5]{BourbakiCA}: we work over $R[[x]]$ which is complete with respect to the ideal $\m = (x)$, and the derivative matrix of $F(x,\iota)$ with respect to $\iota$ is $B$, which is invertible, and $\iota = 0$ gives a solution modulo $\m$. Now for $F$ any power series, let $F_j$ be the polynomial consisting of all terms in $F$ of degree at most $j$, and let $\iota_j$ be the unique power series in $R[[x]]_0^n$ such that $F_j(x,\iota_j) = 0$. Note that both $\iota_j$ and $\iota_{j+1}$ are solutions to $F_j(x,\iota) \equiv 0 \bmod \m^j$, so by the uniquess guaranteed by Hensel's lemma used over $R[[x]]/\m^j$, these must be equal. Hence they converge to $\iota \in R[[x]]_0^n$, which is the unique solution of $F(x,\iota(x)) = 0$.
\end{proof}
This has the following corollary about the inverse of a power series.
\begin{cor}
\label{lem:formalinverse}
Let $x$ have length $n$. Let $a \in R[[x]]_0^n$ with $a \equiv Px \bmod (x)^2$ for some matrix $P\in \GL_n(R)$. Then there is a unique $b \in R[[x]]_0^n$ such that $a \circ b = b \circ a = x$.
\end{cor}
\begin{proof}
Let $F(x,y) = x - a(y)$. This satisfies the constraints of Lemma~\ref{lem:implicitfunction}, so we find a unique $b$ such that $a \circ b = x$. Applying Lemma~\ref{lem:implicitfunction} again gives a unique $c$ such that $b \circ c = x$. But then $a = a \circ (b \circ c) = (a \circ b) \circ c = c$ shows $a = c$ and hence we are done.
\end{proof}
So a formal group $F$ does by Lemma~\ref{lem:implicitfunction} indeed have a right inverse $\iota_F$. Also, by $F(0,0) = 0$ we have that $F(x,F(\iota_f,0)) = 0$ so $F(\iota_f,0)$ is in fact equal to $\iota_F$; as $\iota_F \equiv -x \bmod (x)^2$, it has a formal inverse and hence $F(x,0) = x$, so $0$ is indeed a right unit. A standard argument now shows that $\iota_F$ is also a left inverse and $0$ is also a right unit, so $F$ gives $R[[x]]$, together with the $(x)$-adic topology, the structure of a group object in the category of topological $R$-algebras\todo{Nu zou het goed moeten zijn, toch? Als nog steeds niet: werk in de categorie $(S,I)$ waar $S$ compleet is m.r.t. $I$}; for two continuous morphisms $f_1,f_2$ from $R[[x]]$ to some ring $A$, given by sending $x$ to $a_1,a_2$ respectively, we define $(f_1 \oplus f_2)(x) = F(a_1,a_2)$, and by our considerations this makes $\Hom_{\text{cont}}(R[[x]],A)$ into a group, functorially in $A$.

Given a smooth scheme $G$ over $\Z_p$ of relative dimension $d$, together with a $\Z_p$-point $e$, we can look at the completion $\widehat{O}_{G,e}$ along the section $e$. By smoothness, after picking parameters, this is isomorphic as topological $\Z_p$-algebras to the ring of power series $\Z_p[[x_1,\dots,x_d]]$. This completion naturally gives rise to a formal scheme denoted $\Spf \widehat{O}_{G,e}$; in a categorical notion, this is a functor on finite length $\Z_p$-algebras sending $A$ to $\Hom_{\text{cont}}(\widehat{O}_{G,e},A)$, but we can also think of it as a locally ringed space with $\Spec \Z_p$ as topological space, and sheaf of rings $\lim_n \widetilde{O_{G,e}/m^n}$ where $m$ is the ideal of $O_{G,e}$ defining $e$\todo{Is dit de juiste formulering?}. The global sections of this sheaf are simply $\widehat{O}_{G,e}$. 

If furthermore $G$ is a group scheme over $\Z_p$, then this formal scheme promotes to a formal group scheme, i.e. for every finite $\Z_p$-algebra $A$ the set $\Hom_{\text{cont}}(\widehat{O}_{G,e},A)$ gets a group structure, functorially in $A$. By functoriality, this is the same as an continuous coproduct $\mu: \widehat{O}_{G,e} \to \left(\widehat{O}_{G,e}\right)^{\widehat{\tensor} 2}$. After choosing an isomorphism between $\widehat{O}_{G,e}$ and $\Z_p[[x_1,\dots,x_d]]$, let $F_j \in \Z_p[[x,y]]$ denote $\mu(x_j)$. Then it is clear that $F_G = (F_1,\dots,F_d)$ is a $d$-dimensional formal group scheme, and commutative if $G$ was commutative.
\addtocounter{thm}{-3}
\begin{exmp}[continued]
\label{exmp:gmtoformal}
Take $G = \G_m$ over $\Z_p$, i.e. $\Z_p[u,u^{-1}]$. Then the zero section $e$ is the map sending $u$ to $1$, and we can identify the completion $\widehat{O}_{G,e}$ with the power series ring $\Z_p[[u-1]] \cong \Z_p[[x]]$, sending $u-1$ to $x$. The group structure on $G$ then gives rise to the coproduct $\Z_p[[u-1]] \to \Z_p[[u-1,v-1]], u \mapsto uv$ so the coproduct on $\Z_p[[x]]$ sends $x$ to $uv-1 = (x+1)(y+1) -1 = x + y + xy$. Hence the formal group $F_{\G_m}$ corresponding to this group scheme is exactly the multiplicative formal group from Example~\ref{exmp:gmformalgroup}.
\end{exmp}

This formal group tells us exactly how multiplication works on $G(\Z/p^e\Z)_0$; if we let $t = (t_1,\dots,t_d)$ denote the formal parameters giving the isomorphism $\widehat{O}_{G,e} \to \Z_p[[x_1,\dots,x_d]]$, and we represent a point $P$ in $G(\Z/p^e\Z)_0$ by their parameter values $t(P) \in p\Z/p^e\Z$, then the resulting multiplication on $p\Z/p^e\Z$ obtained from the group structure on $G(\Z/p^e\Z)_0$, i.e. the map $p\Z/p^e\Z \times p\Z/p^e\Z \to p\Z/p^e\Z$, is exactly evaluating $F$. By taking limits, $F$ also gives the multiplication on $G(\Z_p)_0$.

Now we will look at the theory of formal groups, and how that will help us. For a $n$-dimensional formal group $F$ over a ring $R$, Proposition~1.1 of \cite{honda70} gives us a canonical $R$-basis $\omega_1,\dots,\omega_n$ of the right invariant differentials; these are elements of $\bigoplus_{j=1}^n R[[x]] \diff x_j$. If the formal group is furthermore commutative, then by Proposition~1.3 of \cite{honda70} these are closed, i.e. $d\omega_j = 0$. A $1$-form $d\omega = \sum_{i=1}^n f_i \diff x_i$ being closed means exactly that $\frac{\partial f_i}{\partial x_j} = \frac{\partial f_j}{\partial x_i}$ for all $i,j$. From now on, assume $R$ has no torsion; then $R$ imbeds into $\Q \tensor R$ and, we can formally integrate $\omega$, i.e. write it as $df$ where $f \in (\Q\tensor R)[[x]]$. We make this unique by demanding that $f(0) = 0$. Writing this $f$ as $\sum_{I \in \N^n} a_I x^I$ with $I$ denoting a multi index and $a_I \in \Q\tensor R$, we see that $a_I$, although itself not necessarily lying in $R$, is close: writing $I = (I_1,\dots,I_n)$ we see that for all $j$ we must have $I_j a_I \in R$ as $f_j = \frac{\partial f}{\partial x_j} \in R[[x]]$.

In particular, we write $\log_i$ for the unique element of $(\Q\tensor R)[[x]]$ such that $d\log_i = \omega_i$. Together, these $\log_i$ give an element $\log \in R[[x]]^n$, and by Theorem~1 of \cite{honda70}, this logarithm satisfies $\log(x) = x \bmod (x)^2$, and $\log(F(x,y)) = \log(x)+\log(y)$. By the first result, $\log$ has an inverse which we will call $\exp$, also given by powerseries in $(\Q\tensor R)[[x]]$, and also satisfying $\exp(x) = x \bmod (x)^2$.
\addtocounter{thm}{-1}
\begin{exmp}[continued]
Taking $F$ the multiplicative group as in Example~\ref{exmp:gmformalgroup}, Proposition~1.1 of \cite{honda70} gives us $\omega = \frac{1}{x+1}dx$; as a power series this is $\sum_{j \geq 0} (-x)^j$. The formal anti-derivative of this is $\log = \sum_{j \geq 1} \frac{-(-x)^j}{j}dx$ (note this is a translate of the $\log$ from analysis), and Theorem $1$ will tell us what we already know in the context of analysis $\log(x + y + xy) = \log(x)+\log(y)$ (this formula is also a translate of the corresponding formula from analysis). Then analysis will also explicitly tell us what $\exp$ looks like: namely, $\exp(x) = \sum_{j \geq 1} \frac{x^j}{j!}$.
\end{exmp}
\addtocounter{thm}{2}

Now we will see how we can use this formal logarithm in our case of the formal group $F_G$ stemming from a $d$-dimensional smooth group scheme $G/\Z_p$. Recall that we have a bijection $G(\Z_p)_0 \to p\Z_p^d \to \Z_p^d$ given by evaluating at parameters $t = (t_1,\dots,t_d)$ and then dividing by $p$; furthermore, recall that the group structure on $G(\Z_p)_0$ is the same as the group structure defined by $F_G$ on $p\Z_p^d$. Let $\log \in \Z_p[[x]]^d$ denote the logarithm corresponding to $F_G$, and let $\log_p$ denote the power series $\log(px)/p = (\log_1(px)/p,\dots,\log_d(px)/p)$. We then have the following little lemma to bridge the gap between power series and maps.
\begin{lem}
\label{lem:formallog}
With notation as above, we have the following statements about $\log_p$:
\begin{enumerate}
	\item $\log_p$ lies in $\Z_p\angle{x_1,\dots,x_d}^d$, the ring of convergent power series, and hence defines a map $\log_p: \Z_p^d \to \Z_p^d$.
	\item Letting $\oplus$ denote the group structure on $\Z_p^d$ coming from the bijection $G(\Z_p)_0 \to p\Z_p^d \to \Z_p^d$, the map $\log_p$ is a group morphism from $(\Z_p^d,\oplus)$ to $(\Z_p^d,+)$.
	\item If $p > 2$, the map $\log_{p,i}$ reduces to $x_i$ modulo $p$ and hence $\log_p$ has an inverse $\exp_p$, which is also an element of $\Z_p\angle{x_1,\dots,x_d}_0^d$. Then this $\exp_p$ is a two-sided inverse of $\log_p$, and hence $\log_p: \Z_p^d \to \Z_p^d$ is a bijection.
	\item Let $m \in \Z_{>0}$. For $p > m+1$, the map $\log_p$ and $\exp_p$ are of degree at most $m$ modulo $p^m$.
\end{enumerate} 
\end{lem}
\begin{proof}
Write $\log_{i} = \sum_{I} a_{i,I} x^I$ and $\log_{p,i} = \sum_I a_{i,I} p^{|I|-1} x^I$ where $I$ ranges over the multi indices. Recall that $a_{i,0} = 0$. Also, recall that although a priori the coefficients $a_I$ lie in $\Q_p$, we have $I_j a_{i,I} \in \Z_p$ for all $I$ and $i,j$. For purposes of easy estimation, this also means $|I|a_{i,I} \in \Z_p$. As we have, with no constraint on $p$, for all $n\geq 1$ that $c_n\coloneqq p^{n-1}/n$ lies in $\Z_p$ and converges to $0$, this means that \[ \log_{p,i} = \sum_I a_{i,I} p^{|I|-1} x^I = \sum_I |I|a_{i,I} c_{|I|} x^I\] is indeed an element of $\Z_p\angle{x_1,\dots,x_d}^n$, and hence defines a map $\Z_p^d \to \Z_p$. Hence all the $\log_{p,i}$ together give a map $\Z_p^d \to \Z_p^d$. By the equality of power series $\log(F(x,y)) = \log(x)+\log(y)$ from the definition of the logarithm, and the fact that all these powerseries converge on $p\Z_p^d$, this $\log_{p,i}$ is indeed a group morphism from $(\Z_p^d,\oplus)$ to $(\Z_p^d,+)$.

To study $\log_p$ modulo $p$, we note that if $n\geq 3$, then $p$ actually divides $c_n$, and for $p > 2$ we even have $p|c_2$. As $\log_{p,i} = x_i \bmod (x)^2$, this means that for $p > 2$ we have \[\log_{p,i} \equiv \sum_{|I| = 1} |I|a_{i,I}c_{|I|} x^I \equiv x_i \bmod p.\]
Note that as $\log_p \equiv x \bmod (x)^2$, by Lemma~\ref{lem:formalinverse} it has an inverse $\exp_p$ that a priori lies just in $\Z_p[[x]]_0^n$. Modulo $p$, this $\exp_p$ must be $x$, which lies in $\Z_p\angle{x}_0^n$; as $\Z_p\angle{x}$ is $p$-adically complete, using Hensel this shows $\exp_p$ is indeed in $\Z_p\angle{x}_0^n$.

Finally, let $m \in \Z_{>0}$ with $p > m+1$. As $c_n$ has $p$-adic valuation $n-1$ for $n < p$, and $p$-adic valuation at least $p-2 \geq m$ for $n \geq p$, indeed $\log_p$ has degree at most $m$ modulo $p^m$. That the same holds immediately for $\exp_p$, follows immediately from the consideration that the set
\[
S \coloneqq \{f \in \Z/p^n\Z[x]_0^d \mid  f \equiv x \bmod p, \forall m \deg(f \bmod p^m) \leq m\}
\]
forms a group under composition, as we will now see. As $\Z_p\angle{x}$ is complete, we know the superset set of $S$
\[
T \coloneqq \{f \in \Z/p^n\Z[x]_0^d \mid  f \equiv x \bmod p\}
\]
is a group. As $S$ is finite and non-empty, all that remains to show is that $S$ is closed under composition. We can also characterise $S$ as consisting of images $\overline{f}$ of polynomials $f \in \Z_p[x]_0^d$ such that there is a polynomial $\widetilde{f}\in\Z_p[x]_0^d$ with $pf(x) = \widetilde{f}(px)$. If we then take two elements $\overline{f},\overline{g} \in S$, reductions of $f,g$ respectively with $\widetilde{f},\widetilde{g}$ such that $pf(x) = \widetilde{f}(px), pg(x) = \widetilde{g}(px)$, we see that with $h = f\circ g, \widetilde{h} = \widetilde{f} \circ \widetilde{g}$ that $ph(x) = \widetilde{h}(px)$ and $h \equiv \overline{f} \circ \overline{g} \bmod p^m$, so indeed $\overline{f} \circ \overline{g}$ is also an element of $S$. Hence we see $S$ is indeed a group, and as $\log_p \bmod p^m$ is an element of it, so is $\exp_p \bmod p^m$.
\end{proof}

This lemma makes the proof of Theorem~\ref{thm:kappanice} relatively easy. 
\begin{proof}[Proof of Theorem~\ref{thm:kappanice}]
Write $\log_p$ for the logarithm corresponding to the formal group corresponding to the map $\kappa_0: \Z^d \to \Z_p^g$ given by the inclusion $J(\Z)_0$ to $J(\Z_p)_0$ is a group morphism with the group structure on $\Z^d$ being addition and the group structure on $\Z_p^g$, denoted by $\oplus$, given by the bijection with $J(\Z_p)_0$ induced by choosing parameters at $0$, and $\kappa$ is $\kappa_0 \oplus t$. Then by Lemma~\ref{lem:formallog} the map $\kappa$ factors as in the diagram of groups
\[
% https://tikzcd.yichuanshen.de/#N4Igdg9gJgpgziAXAbVABwnAlgFyxMJZABgBpiBdUkANwEMAbAVxiRAAoAdTgLQD0opANQBKEAF9S6TLnyEUAJnJVajFmy68A+mj4BzUtwhpmcMZOnY8BIgEZStlfWatEHbjx37h5lTCh68ESgAGYAThAAtkhkIDgQSPYgDHQARjAMAAoy1vLJMCE4INTO6m7cANZ0aGh0ElIg4VEx1PFISqoubNwMEHo6AATcAMZYYcNDnFU1dRaNEdGIHW2ISaWuINwwAB5oOhIU4kA
\begin{tikzcd}
{(\Z^d,+)} \arrow[rr, "\kappa"] \arrow[rd, "\log_p \circ \kappa"] &                                   & {(\Z_p^g,\oplus)} \\
                                                                  & {(\Z_p^g,+)} \arrow[ru, "\exp_p"] &                  
\end{tikzcd}
\]
Then the arrow $\log_p \circ \kappa$ is just a linear map, and $\exp_p$ is a convergent power series that is of degree at most $m$ modulo $p^m$ for $m < p-1$, so their composite $\kappa$ is also a convergent power series of degree at most $m$ modulo $p^m$ for $m < p-1$
\end{proof}

This immediately gives rise to the following corollary.
\begin{cor}
\label{cor:closurejac}
The map $\kappa: \Z^r \to \Z_p^g$ extends uniquely to a continuous map $\kappa: \Z_p^r \to \Z_p^g$, given by the same power series, and the closure $\overline{J(\Z)_t} \subset J(\Z_p)_t$ is given by the image of $\Z_p^r$ under $\kappa$.
\end{cor}

\section{Computing the intersection}
\label{section:intersection}
Clearly, as subsets of $J(\Z_p)_t$, we have the inclusion $C(\Z)_P \subset C(\Z_p)_P \cap \overline{J(\Z)_t}$. The theory we have built so far enables the following method, which is in sharp contrast with Colemans method; instead of pulling back equations for $\overline{J(\Z)_t}$ to $C(\Z_p)_P$, we pull back equations for $C(\Z_p)_P$ to $\overline{J(\Z)_t}$ to arrive at the following theorem.
\begin{thm}
\label{thm:final}
Let $C,J,p,P,t$ be as in the overview, let $\kappa$ be as in Theorem~\ref{thm:kappanice} and let $f_1,\cdots,f_{g-1}$ be as in Subsection~\ref{subsection:czptojzp}. Define $\lambda_1 = \kappa^*f_1,\dots$, $\lambda_{g-1} = \kappa^*f_{g-1}$ to be the pullbacks along $\kappa$ of the $f_i$. Then $\kappa$ induces a surjection from $Z(\lambda_1,\dots,\lambda_{g-1}) \subset \Z_p^r$ to $C(\Z_p)_P \cap \overline{J(\Z)_t}$.
\end{thm}

Hence if we find an upper bound for the cardinality of $Z(\lambda_1,\dots,\lambda_{g-1})$, this is also an upper bound for $C(\Z)_P$. There are several, sometimes ad hoc, ways of proving finiteness. We start by looking simply at calculations modulo $p$. We let $I$ denote the ideal inside $\Z_p\angle{x_1,\dots,x_r}$ generated by $\lambda_1,\dots,\lambda_{g-1}$, and $A$ the quotient $\Z_p\angle{x_1,\dots,x_r}/I$. Noting that $Z(\lambda_1,\dots,\lambda_{g-1}) = \Hom_{\Z_p}(A,\Z_p)$, we can use the following theorem, the statement and proof of which come from \cite{edixhoven20}.

\begin{prop}
\label{prop:finedix}
Let $\overline{A} = A/pA$. Assume $\overline{A}$ is finite. Then $\overline{A}$ is the product $\prod_{m \in \MaxSpec(\overline{A})} A_m$, and the sum of $\dim_{\F_p} \overline{A}_m$ over those $m\in \MaxSpec(\overline{A})$ with $\overline{A}/m = \F_p$ is an upper bound for $\Hom(A,\Z_p)$.
\end{prop}
\begin{proof}
We start by proving that $A$ is $p$-adically complete. This follows from the following more general fact: let $R$ be a Noetherian ring, and $I,J$ two ideals of $R$ such that $R$ is $J$-adically complete. We will then prove that $R/I$ is also $J$-adically complete. By Theorem 10.17 of \cite{atiyah}, any module over a complete ring injects into its completion, i.e. the map $R/I \to \widehat{R/I}$ is injective. Furthermore, as completion is exact, the surjection $R \to R/I$ gives rise to a surjection $R \to \widehat{R/I}$. The kernel contains $I$, so the map $R/I \to \widehat{R/I}$ is surjective and hence an isomorphism. Then note that $\Z_p\angle{x_1,\dots,x_r}$ is itself the $p$-adic completion of $\Z_p[x_1,\dots,x_r]$ and hence is complete, so $A$ is indeed $p$-adically complete.

Next, we use that $\overline{A}$ is a finite $\Z_p$-module, generated by the image of some finite set $S \subset A$. Using the series of exact sequences \[0 \to \overline{A} \xrightarrow{\cdot p^{n-1}} A/p^nA \to A/p^{n-1}A \to 0,\] we see by induction that $S$ indeed generates $A/p^nA$ as a $\Z_p$-module and by completeness, $S$ generates $A$ as well. Hence $A$ is a finite rank $\Z_p$-algebra.

Remember that a finite dimension algebra over a field is Artinian, and Artin rings are product of Artin local rings (Theorem 8.7 of \cite{atiyah}). So, we can write the $\F_p$-algebra $\overline{A}$ as a product of Artin local rings. As idempotents in $\overline{A}$ lift to $A$, we see this factorisation lifts, and we can write $A$ as
\[
\prod_{m \in \MaxSpec(\overline{A})} A_m.
\]
Then any morphism $A \to \Z_p$ factors through $A_m$. If we tensor $A_m$ with $\Q_p$, we see that, after dividing out the nilradical, it is a product of fields. Hence $\Hom(A_m,\Z_p)$ is at most $\text{rank}_{\Z_p}(A_m)$, and can be non-empty if and only if $A/m$ is isomorphic to $\F_p$. We conclude that the sum of $\dim_{\F_p} \overline{A}_m$ over those $m\in \MaxSpec(\overline{A})$ with $\overline{A}/m = \F_p$ is an upper bound for $\Hom(A,\Z_p)$
\end{proof}

To utilise this theorem, we only need to calculate the $\lambda_i$ modulo $p$. In our case, of all $\kappa_i$ and $f_i$ being linear modulo $p$ (as polynomials; they do not necessarily give linear map), so are the $\lambda_i$, and we get as special case the following corollary.
\begin{cor}
\label{cor:finedixlinear}
If the (not necessarily homogenous) linear system of equations $\forall i: \lambda_i \equiv 0 \bmod p$ has respectively no or one solution, there is respectively none or at most one point in $C(\Z)_P$.
\end{cor}

This leads to a now trivial proposition.\todo{Bas, proposition of theorem?}
\begin{prop}
\label{prop:linchabauty}
If for all points $P \in C(\F_p)$, the linear system of $g-1$ equations modulo $p$ defining $C(\Z_p)_P \subset J(\Z_p)_t$ pulled back to $\overline{J(\Z)_t}$ has at most one solution, we get the inequality
\[
|C(\Z)| \leq |C(\F_p)|.
\]
\end{prop}

Of note is that this upper bound for $C(\Z)$ does not even depend on the genus, and behaves agreeably when compared to the upper bound in Theorem 5.3 of \cite{poonen12}, which tells us that $|C(\Z)| \leq |C(\F_p)| + 2g-2$ under the much lighter condition of $r < g, p > 2g$ where $p$ is still a prime of good reduction. To summarise: in proposition~\ref{prop:linchabauty} we sacrifice certainty for being to able to prove much sharper bounds. However, a simple heuristic analysis shows that the conditions are quite likely to be satisfied, as we shall see in the following lemma and proposition.

\begin{lem}
\label{lem:probindep}
Let $\F_p$ be any finite field, let $A$ be a random $(n+k)\times n$ matrix over $\F_p$, and $b$ randomly chosen from $\in \F_p^{n+k}$. Then the probability that $Ax=0$ has more than one solution is at most $c_k (p-1)^{-(k+1)}$ and the probability that $Ax=b$ has more than one solution is at most $c_k (p-1)^{-(k+1)} p^{-(k+1)}$ where $c_k = \sum_{\ell = 0}^k \binom{k}{\ell}/(\ell+1)! \leq 2^k$.
\end{lem}
\begin{proof}
Let $A_i$ denote the rows of $A$, let the space $V_i$ be the linear span of $A_1,\dots,A_i$ with $V_0 = 0$, and let $E_i$ denote the event that $A_i \in V_{i-1}$. Then we see the row space of $A$ can only fail to be $\F_p^n$ if for $k+1$ different indices $i$, the event $E_i$ takes place. As clearly $\dim V_i \leq i$, we see that $\P(E_i)$ is at most $p^{i-1-n}$ for $i \leq n$ and at most $p^{-1}$ for $i \geq n$. Finally note, that $\P(E_i | E_{j_1} \wedge \cdots \wedge E_{j_\ell}) \leq \P(E_i)$ if all $j_1,\dots,j_\ell$ are smaller than $i$. Now we can make the following calculation
\begin{align*}
\P(\text{At least } k+1 \text{ of } E_i \text{ occur}) &= \P\left(\bigvee_{1\leq i_1 < \cdots < i_{k+1} \leq n + k} \bigwedge_{j=1}^{k+1} E_{i_j} \right) \\
&\leq \sum_{1\leq i_1 < \cdots < i_{k+1} \leq n + k} \P\left(\bigwedge_{j=1}^{k+1} E_{i_j}\right) \\
&\leq \sum_{1\leq i_1 < \cdots < i_{k+1} \leq n + k} \prod_{j=1}^{k+1} \P(E_{i_j}) \\
&\leq \sum_{1\leq i_1 < \cdots < i_{k+1} \leq n + k} \prod_{j=1}^{k+1} p^{{\min(i_j-1-n,-1)}}.
\end{align*}
Then we note that for $\ell = 0,\dots,k$ we have
\begin{align*}
\sum_{1\leq i_1 < \cdots < i_{\ell} \leq n}\prod_{j=1}^{\ell} p^{i_j-1-n} &\leq \frac{1}{\ell!} \sum_{1\leq i_1,\dots,i_{\ell} \leq n} \prod_{j=1}^{\ell} p^{i_j-1-n} \\
&= \frac{1}{\ell!} (\frac{1}{p^n} + \frac{1}{p^{n-1}} + \cdots + \frac{1}{p})^\ell\\
&\leq \frac{1}{\ell! (p-1)^\ell}.
\end{align*}
Now if we partition the sum over all $1\leq i_1 < \cdots < i_{k+1} \leq n + k$ based on how many of the indices lie in $[n+1,n+k]$, we find
\begin{align*}
\sum_{\substack{1\leq i_1 < \cdots \\ < i_{k+1} \leq n + k}} \prod_{j=1}^{k+1} p^{{\min(i_j-1-n,-1)}} &= \sum_{m = 0}^{k} \binom{k}{m}p^{-m}\sum_{1\leq i_1 < \cdots < i_{k+1-m} \leq n}\prod_{j=1}^{k+1-m} p^{i_j-1-n}\\
&\leq \sum_{m = 0}^{k} \binom{k}{m}p^{-m}(p-1)^{-(k+1-m)}/(k+1-m)! \\
&\leq (p-1)^{-(k+1)} \sum_{\ell = 0}^k \binom{k}{\ell}/(\ell+1)! \\
& = c_k (p-1)^{-(k+1)}.\\
\end{align*}
This shows that the probability of $Ax = 0$ having more than one solution is indeed at most $c_k (p-1)^{-(k+1)}$. Furthermore, if $Ax = 0$ has more than one solution, then $\text{rank} A < n$ so there are at most $p^{n-1}$ possible values of $b$ such that $Ax = b$ has multiple solutions, hence the total probability is at most $c_k (p-1)^{-(k+1)} p^{-(k+1)}$.
\end{proof}

For a generic point $P \in C(\F_p)$, we might assume the linear system modulo $p$ defining $C(\Z_p)_P$ pulled back to $\overline{J(\Z)}$ is completely random, but for point $P \in C(\F_p)$ coming from $\Z$-points, we always know there is at least one solution; and indeed, it turns out that with a translation, one can assume the linear system is homogenous.
\begin{prop}
\label{prop:probwork}
Assume that the map $C(\Z) \to C(\F_p)$ is injective. Assume that for points $P \in C(\F_p)$ coming from $C(\Z)$ the linear system modulo $p$ defining $C(\Z_p)_P$ pulled back to $\overline{J(\Z)}$ is a random homogenous linear system, and for all other points, it is a random not necessarily homogenous linear system. Assume furthermore that all these linear systems are independently random. Then for $p > 4g^2$ the conditions of Proposition~\ref{prop:linchabauty} are not satisfied with probability at most
\[
c_{g-1-r}(|C(\Z)|+2)p^{-(g-r)}
\]
Hence for $r = g-1$ we expect a subset of primes with density $1$ to show finiteness of $C(\Z)$, and for $r < g-1$ we expect all but a finite number to work. These expectations are uniform in $g$ and $|C(\Z)|$.
\end{prop}
\begin{proof}
First note that our linear systems consist of $g-1$ equalities in $r$ variable, i.e. we can use Lemma~\ref{lem:probindep} with $k = g-1-r$. Let $a$ denote $|C(\Z)|$, and let $b$ denote $|C(\F_p)|-a$. Under all our assumptions, the probability of none of the systems having more than one solutions is at least
\[
\left(1 - c_k(p-1)^{-(k+1)}\right)^{a} \left(1 - c_k(p-1)^{-(k+1)}p^{-(k+1)}\right)^b.
\]
Using the Bernoulli's inequality, this is at least 
\[
\left(1- ac_k(p-1)^{-(k+1)}\right)\left(1 - c_k(p-1)^{-(k+1)}p^{-(k+1)}\right)
\]
which is itself at least $1 - ac_k(p-1)^{-(k+1)} - bc_k(p-1)^{-(k+1)}p^{-(k+1)}$. Using the Hasse-Weil bound, we can make the estimate $b \leq 2p$. Then we can lower bound this by $1 - ac_k(p-1)^{-(k+1)} - 2c_k(p-1)^{-(2k+1)}) \geq 1 - c_k(a+2)(p-1)^{-(k+1)}$.

For $r = g-1$ we have $k= 0$, and the probability of one of the conditions not being satisfied is at most $(a+2)/p$, hence we indeed expect an infinite but density $0$ subset of primes to fail. For $r < g-1$, we have $k > 0$; as $\sum_{p\text{ prime}} 1/p^2$ converges, one may expect a finite number of primes to fail.
\end{proof}
\begin{rem}
The author believes that this proposition gives a strong reason to expect the method of only computing modulo $p$ to work in practice; and if it does not, one can just take the next prime.
\end{rem}
\begin{rem}
Note that if $r=g-1$, as we expect a random $n\times n$-matrix to be invertible, we expect that if the conditions of Proposition~\ref{prop:linchabauty} are satisfied, we generally find an upper bound for $|C(\Z)|$ slightly lower than $|C(\F_p)|$. However, a not necessarily inhomogenous linear system of dimension $(n+k)\times n$ is solvable with probability at most $p^{-k}$, as the dimension of the column space is at most $n$. Hence for $r = g-2$ we can expect to find an upper bound of about $|C(\Z)|+1$, and with probability about $(1-\frac{1}{p})^{|C(\F_p)|} \approx (1-\frac{1}{p})^p \approx e^{-1}$ \todo{Extra heuristiek!}even the optimal upper bound of $|C(\Z)|$. For $r = g-3$, we even expect to find an upper bound of $|C(\Z)|$ for a set of primes of density $1$; and for $r < g-3$, for all but a finite set of primes. 
\end{rem}

Now we briefly discuss what can be done if for a specific prime $p$, the conditions of Proposition~\ref{prop:linchabauty} are not satisfied. In general, even if $\overline{A}$ is not finite, we see $\Hom(A,\Z_p)$ factors through $\Z_p\angle{x_1,\dots,x_r}/(I:p)$ where $(I:p)$ is the saturation \[\{x \in \Z_p\angle{x_1,\dots,x_r} \mid \exists k \in \Z_{\geq 0}: p^kx \in I\}\] Then a higher precision calculation of the $\lambda_i$ can still lead to a succesful application of Proposition~\ref{prop:finedix}.

Another specific case is that of $r = 1$. In that case, we can use finite precision approximations of $\lambda_1$ to deduce information about its Newton polygon, and use that to bound the number of zeroes in $\Z_p$. We can even adapt this method if $r$ is bigger than $1$; sometimes it might be possible to use the implicit function theorem for powerseries, Lemma~\ref{lem:implicitfunction}, to write one of the variables as a power series in the other variables, and then substitute it in the other equations.

\begin{exmp}
If $r = g-1 = 2$ and $\lambda_1 \equiv px-py,\lambda_2 \equiv x+y+pxy \bmod p^2$, neither Proposition~\ref{prop:finedix} nor Newton polygons are instantly applicable. However, substituting $y = -x +px^2 \bmod p^2$ into the first equation gives $2p(x-x^2) = 0 \bmod p^2$, or $x-x^2 = 0\bmod p$. Now both Proposition~\ref{prop:finedix} and Newton polygons give an upper bound of $2$ for $C(\Z)_P$.
\end{exmp}

\section{Complications and improvements}
\label{section:remarks} \todo{Bas, het is niet alleen werk van anderen, hopelijk is het nu duidelijker}
In this section, we quickly make some further remarks on how or when to apply the theory we have built up in previous section to real cases.
\begin{itemize} 
\item Even if $r \geq g$, it might still be possible that $\overline{J(\Z)}$ coincidentally has dimension $r'$ smaller than $r$ (for example, if $r > g$); then one can find a rank $r'$ subgroup of $J(\Z)$ with the same closure inside $J(\Z_p)$, and do computations in this subgroup; we can expect this to work if $r' < g$. We can even use this to improve our calculations if we already have $r < g$, but $r'$ is even smaller. On the other hand, if $J(\Z)$ is dense in $J(\Z_p)$, there is no way to apply Chabauty's method to the curve.
\item Note that in all of the discussion of the previous section, we are calculating upper bounds for the cardinality of $C(\Z_p)_P \cap \overline{J(\Z)_t}$. It can and does however happen that this set is strictly bigger than $C(\Z)_P$, as shown in \cite{Balakrishnan19}, where Coleman-Chabauty is used on a whole database of curves. They treat several possible cases and examples where the set is bigger. For example, there might be a $K$-point $Q$ where $K$ is a quadratic field where $p$ splits, such that $Q-b$ lies in $J(\Z_p)_0$ and is non-$p$-torsion in $J(\Z_p)_0/J(\Z)_0$; then, as $J(\Z_p)$ is isomorphic as continous group to $\Z_p^g$, the point $Q-b$ lies in $\overline{J(\Z)_0}$, and clearly also in $C(\Z_p)$.\todo{Bas, explanation added}
\item An important part of doing these calculations, is working with the Mordell-Weil group $J(\Z)$. In general, finding generators of $J(\Z)$ is computationally out of reach, and one may need to assume the BSD conjecture to even find the rank $r$. However, note that one does not need to find all of $J(\Z)$; if we can generate a subgroup of $J(\Z)$ of index finite and coprime to $p|J(\F_p)|$, it will have the same closure in $J(\Z_p)$. For this, we only need to generate sufficiently many independent points of the Jacobian, and saturate subgroups with respect to some primes. Both of these feats are easier than finding all of $J(\Z)$.
\item Even this method does not work for a certain prime $p$, and neither for some other primes we tried, we can still use parts of the information we have learned. For example, maybe the method tells us that we have found all points of $J(\Z)$ stemming from $C(\Z)$ except those in a certain fibre of the map $J(\Z) \to J(\F_p)$. We can then aggregate this information for different primes, by looking at the maps $J(\Z) \to \prod_{p \in S} J(\F_p)$ for some set $S$ of primes of good reduction. See for example \cite{stoll10} for an introduction to the Mordell-Weil sieve.
\end{itemize}

\section{Implementations of linear Chabauty}
\label{section:explicit}
We now assume that $C$ is hyperelliptic, i.e. given by the degree $2g+2$ homogenisation of an equation of the form
\[
y^2 = f(x)
\]
inside $\P(1,g+1,1)$ where $f$ is a monic polynomial of degree $2g+1$ or $2g+2$. An alternative way of defining such a curve, and the one we will be using mainly, is as a glueing of two affine charts: $y^2 = f(x)$, and $w^2 = f^{r}(v)$, where $f^{r}(v)$ is the polynomial $v^{2g + 2} f(1/v)$, and a birational map between them is given by $(x,y) \mapsto (\frac{1}{x},\frac{y}{x^{g+1}})$. We also have the coordinates $X,Y,Z$ of $\P(1,g+1,1)$, with $x = X/Z, y = Y/Z^{g+1}, v = Z/X, w = Y/X^{g+1}$, but beware; these coordinates do not behave nicely on the origin of the patch $D(Y)$. We mainly use the first chart; we call any point that lies on it an affine point of $C$. We will treat the case that $f$ has degree $2g+2$ (this can be done by translating $f$ until the constant coefficient is non-zero, and then looking at $f^r$). In that case, near the line at infinity $C$ looks like $Y^2 = X^{2g+2}$, i.e. $(Y-X^{g+1})(Y+X^{g+1}) = 0$, and we see there are two points $\infty_+ = (1:1:0)$ and $\infty_- = (1:-1:0)$. Finally, we note that there is an involution on $C$ given by $\sigma(x,y) = (x,-y)$ and $\sigma(v,w) = (v,-w)$.

\subsection{Makdisis algorithms}
We work in the Jacobian using Makdisi's representations for divisors. As we are using and adding on to an implementation by Mascot \cite{mascot18}, we briefly introduce his notation. This is a summary of section 2.1 in \cite{mascot18}.

We first look at representing $J(k)$ where $k$ is a field. Given a divisor $D$ on $C$, denote
\[
\Lcal(D) = \{f \in k(C)^\times : \div(f) + D \geq 0 \} \sqcup \{0\}.
\]
We pick $D_0$ an effective divisor of degree $d_0 \geq 2g+1$; in the case of hyperelliptic curves, this will be $(g+1)(\infty_+ + \infty_-)$. We set $V_n = \Lcal(nD_0)$. We let $n_Z$ be an integer $\geq 5d_0 + 1$, and assume, if necessary passing to an extension of $k$, that we have a set $Z$ of size $n_Z$ of distinct points in $C(k)$ outside the support of $D_0$; in fact, this will consist of affine points in our case. We have an evaluation map $V_5 \to k^Z$, evaluating a rational function at $Z$. By our choice of $n_Z$, this is an injective map, i.e. we can represent rational functions in $V_5$ by their values in $k^Z$. In this representation, we can add, subtract, or, if the degree at infinity is not too large, even multiply rational functions, by respectively adding, subtracting or multiplying the correspondig vectors in $k^Z$. It is now also possible to represent subspaces of $V_5$ by giving a basis in $k^Z$. (Instead of passing to an extension of $k$, one could also evaluate functions on infinitesemal neighborhoods of $k$-points, i.e. compute Taylor expansions near those points.)

We now explain the representation of $J(k)$. Note that for any $x \in J(k)$, we have that $x + [D_0]$ is a divisor class of degree at least $2g+1$ and hence is equivalent to an effective divisor $E \geq 0$ of degree $d_0$. Then we represent $x$ by $\Lcal(2D_0 - E)$ inside $V_2$; by Riemann-Roch this is a $d_W$-dimensional subspace of $V_2$ where $d_W = d_0 + 1 - g$, and in particular we can represent it as a $n_z \times d_W$ matrix, itself representing a subspace of $k^Z$. This representation is nowhere near unique; there are many different effective divisors $E$ equivalent to $x + D_0$, and many bases for a subspace of $k^Z$.

As explained in Mascot's article, using this representation one can do all relevant computations in $J(k)$; adding, subtracting, finding the zero element, and most importantly: checking equality. Important from a computational standpoint is the complexity; as everything is simply linear algebra in spaces of dimensions $O(g)$, the complexity of all these operations, assuming calculations in the ground ring are $O(1)$, are all simply $O(g^\omega)$ where $\omega$ is the matrix constant.

\subsubsection{Going from \texorpdfstring{$\F_p$}{Fp} to \texorpdfstring{$\Z/p^e\Z$}{Z/peZ}}
We now know how to compute in $J(k)$ for $k$ a field such that $C(k)$ is big enough. In practice, if we want to calculate in $J(\F_p)$, this means passing to $J(\F_q)$ for some $q = p^a$ with $a$ large enough; by the Hasse-Weil bound this will work. However, for Chabauty we want to compute inside $J(\Z/p^e\Z)$. Luckily, Mascots code takes care of this too, by passing from vector spaces over $\F_p$ to free $R$-submodules of $R^n$ with $R = \Z/p^e\Z$; in fact, all submodules of $R^n$ we will be seeing are free. That means all these submodules will have good reduction, i.e. they will remain free and of the same rank after tensoring with $\F_p$. If the maps between such modules also have good reduction, then all kernels, images, et cetera will also have these properties, and can first be calculated modulo $p$ using linear algebra and then by Hensel lifting modulo higher powers of $p$.

The final trick we need is extensions of $\Z/p^e\Z$. As said before, we need $n_Z$ affine points that are distinct modulo $p$, so we passed from $\F_p$ to an extension of $\F_q$. The corresponding notion of an extension of $\Z/p^e\Z$ is given by taking an irreducible polynomial $\overline{T} \in \F_p[t]$ with $\F_q \cong \F_p[t]/\overline{T}$, arbitrarily lifting $\overline{T}$ to a polynomial $T \in \Z/p^e\Z$, and looking at $R = \Z/p^e\Z[t]/T$. Again, we will only be looking at free submodules of $R^n$, so we can again do normal linear algebra over $R \tensor \F_p = \F_q$, and using Hensel to lift.

\subsection{Implementing the Abel-Jacobi map and Mumford representations}
Now that we can do computations with elements in the Jacobian over $\Z/p^2\Z$, it only remains to construct elements in the Jacobian. Explicitly, we want to go from a degree zero divisor to an element in Mascots representation. Most of the times these divisors are sums of points over the ring we are working with, but sometimes they are given as a Mumford representation.
\begin{defn}
Let $C$ be any (hyper)elliptic curve given by $y^2 = f(x)$ with $f$ of degree $2g+2$ where $g$ is the genus of $C$. A Mumford representation is a pair $(a,b)$ with $a,b$ polynomials in $x$, representing the degree $0$ divisor $D(a,b)$ on $C$, given on the first affine chart by the equation $a(x) = 0, y = b(x)$ and on the line at infinity by $-\deg a\infty_+$. Such a pair $a,b$ is required to satisfy that
\begin{enumerate}
\item the polynomial $b$ is of degree at most $\deg a -1$;
\item the polynomial $a$ is monic of degree at most $g+1$;
\item the polynomial $a$ divides $f - h^2$.
\end{enumerate}
\end{defn}
\begin{rem}
If $b$ does not satisfy the first condition, we can reduce $b$ modulo $a$. If $a$ does not satisfy the second condition, we can use the formula that on the first affine chart, we have
\[
D(a,b) + D\left(\frac{f-b^2}{a},b\right) = (y-h)
\]
meaning that with additional calculations of the behaviour of $(y-h)$ at infinity we can express $[D(a,b)]$ in the Jacobian in terms of $D(\frac{f-b^2}{a},b)$, and if $\deg a$ is strictly bigger than $g+1$, the degree of $\frac{f-b^2}{a}$ is at most $\deg a -2$.
\end{rem}

We will treat both how to explicitly compute the Abel-Jacobi embedding and divisors in Mumford represenation in Makdisi's representation for the Jacobian. We start with the Abel-Jacobi embedding 
\begin{align*}
j_{\infty_+}: C &\to J \\
              P &\mapsto P-\infty_+.
\end{align*}
We will only need $j_{\infty_+}(P)$ and $j_{\infty_-}(P)$ for affine points $P$; as the calculation of $j_{\infty_-}(P)$ is entirely similar to $j_{\infty_+}(P)$, we only focus on $j_{\infty_+}(P)$. For this, we present the following algorithm:

\begin{algorithm}[H]
\label{alg:abeljacobi}
 \KwData{$C,J$, an affine point $P \in C(R)$ where $R = \Z/p^e\Z)$}
 \KwResult{A space of the form $\Lcal(2D_0 - E)$ where $E-D_0 = P - \infty_+$ as divisors and $E \geq 0$}
 $Z' \leftarrow Z \sqcup \{P\}$\;
 $B = (b_1,\dots,b_{g+3}) \leftarrow$ a basis of $\Lcal(D_0)$\; \label{alg:abeljacobi:basisLD0}
 \eIf{$(f^r)'(0) \not= 0$}{
   $F \leftarrow x^{g+1} + y$\;\label{alg:abeljacobi:defF1}
   }{
   $F \leftarrow x^{g+1} + x^g +  y$\;\label{alg:abeljacobi:defF2}
  }
 $b_{g+4} \leftarrow xF$\;
 $W \leftarrow$ a $(n_Z + 1)\times (g+4)$ matrix with rows being the evaluations of $B\sqcup{b_{g + 4}}$ on a point in $Z'$.\;
 $V \leftarrow \ker(\im W \subset R^{n_Z + 1} \to R)$, the projection on the last coordinate.\; \label{alg:abeljacobi:kerp}
 %Calculate $\Lcal(D_0 + \infty_+ - P)$\;
 $U \leftarrow \im(V \to R^{n_Z})$, where the last map is the projection on the first coordinates.\;
 Return $U$\;
 \caption{The Abel-Jacobi embedding}
\end{algorithm}

\begin{prop}
\label{prop:abeljacobi}
Algorithm~\ref{alg:abeljacobi} gives correct output.
\end{prop}
Before this proof, we start with a quick lemma.
\begin{lem}
\label{lem:poles2d0i+}
The poles of $F$, as defined in line~\ref{alg:abeljacobi:defF1} or \ref{alg:abeljacobi:defF2}, are $g(\infty_+ + \infty_-) + \infty_+$. 
\end{lem}
\begin{proof}
We start by recalling that at the other affine patch, the curve $C$ is given by $w^2 = f^r(v)$ and by the assumption that $f$ is monic of degree $2g+2$ we have $f^r(0) = 1$. The points $\infty_\pm$ correspond to $(v,w) = (0,\pm 1)$ in this patch. Letting $g^r(v)$ be the polynomial $(f^r(v)-1)/v$, we can rewrite the equation for $C$ to $(w-1)(w+1) = vg^r(v)$. As the derivative of $(w-1)(w+1)$ to $w$ does not vanish at both of $\infty_\pm$, we see that $v$ is a uniformiser at both these points. That means that $v_{\infty_\pm}(x)$, the order of $x$ at $\infty_\pm$, is equal to $-1$.

Now, if $g^r(0)$ is non-zero, then $w- \pm 1$ is also a uniformiser at $\infty_\pm$ and non-zero at $\infty_\mp$, so \[(w+1)/v^{g+1} = y + x^{g+1}\] has poles exactly $(g+1)(\infty_+ + \infty_-) - \infty_-$ as we wanted to show.
And if $g^r(0)$ is zero, then $v_{\infty_\pm}(w-\pm1)$ is at least $2$ so $w-\pm 1 + v$ is a uniformiser at $\infty_\pm$ and non-zero at $\infty_\mp$, so \[(w+1+v)/v^{g+1} = y + x^{g+1} + x^{g}\] again has the right poles.
\end{proof}
\begin{rem}
\label{rem:complexityabel} Clearly, the complexity of Algorithm~\ref{alg:abeljacobi} is $O(g^\omega)$. For a point in the Jacobian that is represented as $\sum P_i - gb$, this gives an $O(g^{\omega+1})$ algorithm for computing it in Makdisi's representation.
\end{rem}

\begin{proof}[Proof of Proposition \ref{prop:abeljacobi}]
First note that by Riemann-Roch, the dimension of $\Lcal(D_0)$ is $g + 3$, and we also have by the proof of the previous lemma that $1,x,\dots,x^{g+1},y$ all lie in $\Lcal(D_0)$ and hence form a basis, so we can indeed find $B$ as in line~\ref{alg:abeljacobi:basisLD0}. Note that by Lemma~\ref{lem:poles2d0i+} the element $b_{g+4}$ lies in $\Lcal(D_0 + \infty_+)$ but not in $\Lcal(D_0)$, so as adding a point to a divisor causes the the dimension to increase by at most $1$, we have by that $b_1,\dots,b_{g+4}$ is a basis for $\Lcal(D_0 + \infty_+)$; that it is in fact a basis is evident as this argument tells us it is a basis when tensored with $\F_p$.

Evaluating $\Lcal(D_0 + \infty_+)$ on $P$ gives a linear map $\Lcal(D_0 + \infty_+) \to R$, and the kernel is exactly $\Lcal(D_0 + \infty_+ - P)$; this is the resulting $U$ in line~\ref{alg:abeljacobi:kerp}. Furthermore we have the equality of divisors $P-\infty_+ = E - D_0$ where $E = P + D_0 - \infty_+ \geq 0$, so $\Lcal(D_0 + \infty_+ - P)$ is as a subspace of $V_2$ equal to $\Lcal(2D_0 - E)$. This last term is in fact in Mascots representation, so this represents $P-\infty_+$ in the Jacobian.
\end{proof}

Now we move on to the Mumford representation. We present a way to go from the Mumford representation of a divisor to a Makdisi representation for the corresponding point on the Jacobian. This is based on private correspondence between Mascot and the author.
\begin{proof}[Algorithm/proof]
Let $(a,b)$ be the Mumford representation of a divisor $D$. Let $\deg a = d \leq g$, and denote $D_{\text{aff}}$ for the affine part of $D$. Note that $E-D_0 = D$ for $E = D_0 + D_{\text{aff}} - d\infty_+$, an effective divisor, so $\Lcal(2D_0 - E) = \Lcal(D_0 - D)$ is a Makdisi representation for $[D]$.

Of course, we can rewrite $\Lcal(D_0 -D)$ as 
\begin{multline*}
\Lcal((g+1)\infty_- + (g+1+d)\infty_+ - D_{\text{aff}}) \\= \Lcal(2D_0 - D_{\text{aff}} ) \cap \Lcal((g+1)\infty_- + (g+1+d)\infty_+).
\end{multline*}

We first calculate $\Lcal(2D_0 - D_{\text{aff}})$. Over $\F_p$ we have the equality
\[
\Lcal(2D_0 - D_{\text{aff}}) = a(x)\Lcal((2g+2-d)(\infty_- + \infty_+)) + (y-b(x))\Lcal((g+1)(\infty_- + \infty_+)).
\]
Note all these Riemann-Roch spaces are of the form $H^0(C_{\F_p},\Fcal_{\F_p})$ where $\Fcal$ is a sheaf on $C_{\Z_p}$ of degree higher than $2g-2$. Hence by Serre duality, $h^{1}(C_y,\Fcal_y)$ is $0$ for all $y \in \Spec \Z_p$. Then as the Euler characteristic is constant, also $h^{0}(C_y,\Fcal_y)$ is constant. By III.12.9 of \cite{hartshorne}, we see the basechange morphism $H^0(C_{\Z_p},\Fcal_{\Z_p}) \tensor \F_p \to H^0(C_{\F_p},\Fcal_{\F_p})$ is an isomorphism and $H^0(C_{\Z_p},\Fcal_{\Z_p})$ is a free $\Z_p$-module. That means this equality also holds over $\Z_p$, and hence over $\Z/p^k\Z$. then it should follow over $\Z_p$ so over $\Z/p^k\Z$. \todo{Bas, dit is het huidige argument} 

For $\Lcal((g+1)\infty_- + (g+1+d)\infty_+)$, we first inductively calculate the spaces $W_n := \Lcal(2D_0 - n\infty_-)$. For $W_1$ we have a basis $1,x,\dots,x^{2g+1},y,xy,\dots$, $x^g y, x^{g+1}y+x^{2g+2}$, and for $n \geq 0$ we have by a simple use of Lemma 2.2 of \cite{makdisi04} that for $1 \leq n \leq g+1$ we have \[W_{n} = \{s \in \Lcal(2D_0) \mid s\Lcal(2D_0) \in W_1 \cdot W_{n-1}\}\]. This is a purely linear constraint, hence simple linear algebra allows us to calculate all $W_n$ for $n \leq g+1$. Finally, we have
\[
\Lcal((g+1)\infty_- + (g+1+d)\infty_+) = \{ s \in \Lcal((g+1+d)(\infty_+ + \infty_-)) \mid sx^{g+1-d} \in W_d).
\] 
Once again noting that we can write down an explicit basis for the space $\Lcal((g+1+d)(\infty_+ + \infty_-))$, this allows us to calculate $\Lcal((g+1)\infty_- + (g+1+d)\infty_+)$ and to finish the computation.
\end{proof}

\subsection{Parameters at \texorpdfstring{$J$}{J}}
\label{subs:paramj}
Being able to calculate in the Jacobian, we can move on to the final ingredient for explicit computations: parameters at points of $J$. For any nice curve $C$ over $\Z$, smooth over $\Z_{(p)}$, with a $\Z$-point $b$, we have a birational map from $C^{(g)}$, the $g$-fold symmetric product of $C$, to $J$, given on points by sending $[(P_1,\dots,P_g)]$ to $[\sum P_i - gb]$. This map is \'etale at $[(P_1,\dots,P_g)]$ if $H^0(P_1 + \cdots + P_g)$ has dimension $1$ as the fibre of $P_1 + \cdots + P_g -gb$ is exactly $\P H^0(P_1 + \cdots + P_g)$. Also, if all $P_i$ are distinct, then the map $C^g \to C^{(g)}$ is \'etale at $P_1,\dots,P_g$ as well. Then finding parameters $t_1,\dots,t_g$ at $Q := [\sum_{i=1}^g P_i - gb]$ just comes down to finding parameters at each of the $P_i$. In our case of a hyperelliptic curve, this is just an easy computation; for a point $(a,b)$ on the first affine chart, we can take $x-a$ if $b$ is non-zero and $y$ if $a$ is zero. We can also compute the inverse of the map $C(\Z/p^k\Z)_{P_i} \to p\Z/p^k\Z$; this is just a simple exercise in Hensel lifting.

This now means $J(\Z_p)_Q$ is parametrised as the product of $C(\Z_p)_{P_i}$. In particular, we have a bijection
\[
\prod_{i=1}^g C(\Z/p^k\Z)_{P_i} \to J(\Z/p^k\Z)_{Q}.
\] As we are able to explicitly compute this map using the Abel-Jacobi map, and we are able to test equality in $J(\Z/p^k\Z)$, we can compute the map $(t_1,\dots,t_g): J(\Z/p^k\Z)_Q \to (p\Z/p^{k}\Z)^g$ by first computing its inverse and storing all found values. This gives an algorithm for computing this map that consists of $O(p^{(k-1)g})$ operations in the Jacobian.

\begin{rem}
\label{rem:faster}
We can do this faster at the cost of consistency, by applying another algorithm by Mascot, Algorithm~7 in \cite{mascot18}. This algorithm computes a rational map $J \to \P V_2$, dependent on the choice of some specific degree effective divisors, with complexity $O(g^\omega)$. Of course, it is trivial to compute parameters in $\P V_2$, but the downside is that the rational map may not need to be defined where we want it to be. In that case, one can just take another choice of effective divisors and construct a different rational map; remember that we only need the map to be defined in our residue disc of choice.
\end{rem}

\subsection{Interpolating polynomials}\todo{Dit stuk is herschreven}
\label{subs:interpolate}
The $\lambda_i$ from Theorem~\ref{thm:final} are in general not computationally available, as they are power series, but we can approximate them modulo powers of $p$. For example, we know that the $\lambda_i$ are linear modulo $p$. And in particular, if $f_1,\dots,f_{g-1}$ are as in Remark~\ref{rem:fislinear}, then $\lambda_i = \kappa_i$ for $i \leq g-1$, so they are also of degree at most $m$ modulo $p^m$ for $m < p-1$. Knowing this, we can compute $\lambda_i$ modulo powers of $p$ by interpolation, and the following formula, coming from \cite{salzer}: if $f$ is a polynomial over a ring $R$ of degree $m$ in $n$ variables and $m!$ is a unit in $R$, then we have the equality of polynomials
\[
f(x_1,\dots,x_n) = \sum_{i_1 + \cdots + i_n \leq m} f(i_1,\dots,i_n) \binom{m-x_1-\cdots-x_n}{m-i_1-\cdots-i_n} \prod_{j=1}^n \binom{x_j}{i_j}.
\]
Note that this formula requires evaluation of $f$ at $\binom{m+n}{n}$ points; this is clearly optimal, as there are $\binom{m+n}{n}$ monomials of degree at most $m$. Also note that for $m=1$, the complexity of calculating this formula is simply $O(n)$ applications of $f$, and $O(n)$ calculations in $R$.

Note that evaluating $\lambda_i$ at a point in $J(\Z)_t$ comes down to calculating the value of a parameter at that point, and this is something we can do. That means we can explicitly compute $\lambda_i$ modulo $p^m$ for $m < p-1$. Using Proposition~\ref{prop:finedix} or another way, we can hope to find an upper bound on the number of common zeroes of the $\lambda_i$, and hence an upper bound on $C(\Z)_P$.

This formula for interpolation unfortunately does not work for $m \geq p$; then the values of $\lambda_i$ on $\F_p^{n}$ do not determine $\lambda_i$, and one needs to evaluate on extensions on $\F_q^n$ and look for more general interpolation formulas (e.g., Lagrange interpolation).

\subsection{Complexity}
We assume necessary data for the Mordell-Weil group of the Jacobian is given; that is, we have a set of generators for either $J(\Z)$, or just a full rank subgroup of index coprime to $pJ(\F_p)$. We also assume that all relevant elements in $J(\Z)$ and $J(\F_p)$ are in the subgroup generated by $C(\Z)$ and $C(\F_p)$. Finally, we assume that we can find rational maps $J \to \P V_2$ as in Remark~\ref{rem:faster}.

Then by Remark~\ref{rem:complexityabel} and Section~\ref{subs:interpolate}, we compute $\lambda_i \bmod p$ in $O(rg^{\omega+1})$; then solving the linear system of equations $\forall i \lambda_i \equiv 0 \bmod p$ has complexity lower than that, and hence checking if $|C(\Z)_P|$ is at most $1$ can be done in $O(rg^{\omega+1})$. Repeating this for all $\F_p$-points, gives by the Hasse-Weil bound a complexity of $O\left((p + g\sqrt{p})rg^{\omega+1}\right)$.

\section{An explicit example}
\label{section:example}
We treat the hyperelliptic curve $C$ with first affine chart given by
\[
y^2 = f(x) = x^6+ 8x^5+ 22x^4+ 22x^3+ 5x^2+ 6x+ 1.
\]
This curve has genus $2$, and the Mordell-Weil group is isomorphic to $\Z$. This curve is also treated in Example~8.2 of \cite{poonen12}.

We denote the standard involution on this curve by $\sigma$. It has six known rational points $\infty_+,\infty_- = \sigma(\infty_+)$ and $\theta = (0,1),\sigma(\theta),\eta=(-3,1),\sigma(\eta)$. We take $p = 5$. It turns out that $C(\F_5)$ has seven points; the reductions of the rational points, and $(1,0)$. Again taking the map $C \to J$ to be subtraction of $\infty_+$ on points, all seven points in $C(\F_5)$ lie in the image of $J(\Z)$.

We will first show there is at most one point in the same residue disc as $\theta$. As we already know there is at least one point, namely $\theta$, we can simplify the calculations by looking at the map $j_{\theta}: C \to J$ to be subtraction of $\theta$. Letting $\theta_{\mu}$ for $\mu \in \F_p$ denote the deformations of $\theta$ in $C(\Z/p^2\Z)_{\theta}$, with $\theta_\mu \mapsto \mu$ being a parameter at $\theta$, we see the image of $C(\Z/p^2\Z)_\theta$ in $J(\Z/p^2\Z)_0$ is $\{\theta_\mu - \theta \mid \mu \in \F_p\}$. Also, identifying $J(\Z)_0$ with $\Z^r$, the image of $J(\Z)_0$ in $J(\Z/p^2\Z)_0$ can be given as a map $\F_p^r \to J(\Z/p^2\Z)_0$. Choosing parameters by giving a local chart $J \to \P(V_2)$, we want to exactly show that the two maps $C(\Z/p^2\Z)_\theta \to J(\Z/p^2\Z)_0, \F_p^r \to J(\Z/p^2\Z)_0$ together form a map $\F_p \oplus \F_p^r \to J(\Z/p^2\Z)_0$ with kernel $0$. Now that this is a statement in linear algebra, it can be verified easily, and it turns out that indeed the residue disc of $C(\Z)$ containing $\theta$ contains only $\theta$.

Similarly, it follows that all points in $C(\F_5)$ lift to at most one $\Z$-point. Noting that the group generated by $\sigma$ acts on $C(\Z)$ and has no fixed points, this means $|C(\Z)| \leq 6$ so our list of rational points is complete.

Code for the calculations in this section can be found in \cite{spelier2020}.
\todo{Bas, hiervoor ben ik nu gegaan} 

\section{Quadratic Chabauty}
\label{section:quadratic}
In this section we attempt to give an introduction to the article~\cite{edixhoven20} aimed to introduce all the players in quadratic Chabauty at a slightly slower pace. We will omit any proofs. For further reading, see for example \cite{hashimoto20}, an in progress cartoon guide to the article by Edixhoven-Lido.

% Explain all diagrams over Q
We start with explaining the idea over $\Q$; we let $C_\Q$ be a projective, smooth curve over $\Q$ of genus at least $2$, we let $J_\Q$ be its Jacobian. We again assume the existence of a rational point $b \in C_\Q(\Q)$, and use it to construct an embedding $j_b : C_\Q \to J_\Q$. We wish to set up a similar situation to classic Chabauty, and for that we introduce the Poincar\'e line bundle and Poincar\'e torsor. For this we need $J_\Q^\wedge$, the dual of $J_\Q$, which in fact is isomorphic to $J_\Q$, taking as isomorphism for example the principal polarisation $\lambda: J_\Q \to J_\Q^\wedge$. This dual parametrises line bundles that are algebraically equivalent to $0$ on $J_\Q$, and hence we get a universal such line bundle $P_\Q$ on $J_\Q \times J_\Q^\wedge$, called the Poincar\'e line bundle $P_\Q$, which also satisfies that both $P_{\Q,0\times J_\Q^\wedge}$ and $P_{\Q,J_\Q \times 0}$ are trivial.

\begin{exmp}
If $C_\Q$ is an elliptic curve then, identifying $C_\Q,J_\Q$ and $J_\Q^{\wedge}$, we get $P_\Q = O(\Delta-\{0\} \times C_\Q - C_\Q \times \{0\})$, indeed with the fibres $P|_{\Q,c \times E_\Q} \cong O(c-0)$ being exactly the degree $0$ line bundles on $C_\Q$ up to isomorphism.
\end{exmp}

The object we will be working with is the Poincar\'e torsor, the $\G_m$ torsor over $J_\Q \times J_\Q^\wedge$ defined by \[
P_\Q^\times = \text{Isom}_{J_\Q \times J^\wedge_\Q}(O_{J_\Q \times J^\wedge_\Q},P_\Q);
\] 
we can also describe this in terms of its functor of points; for any scheme $S$ over $J_\Q \times J^\wedge_\Q$, we have that $P^\times_\Q(S)$ is the set of isomorphisms betweeen $O_S$ and $(P_\Q)_S$, with a free, transitive action of $O_S(S)^\times$, i.e. a torsor of $O_S(S)^\times$ in the traditional group-theoretic sense (note that this torsor can be empty).

Furthermore, this Poincar\'e torsor has a nice structure of a biextension; this means we can think think of the fibers $P^\times_{\Q,(x,y)}$ as being a $\G_m$ above the point $x \times y$; this structure then gives multipliction maps \[P^\times_{\Q,(x_1,y)} \times P^\times_{\Q,(x_2,y)} \to P^\times_{\Q,(x_1+x_2,y)}\] and similarly \[P^\times_{\Q,(x,y_1)} \times P^\times_{\Q,(x,y_2)} \to P^\times_{\Q,(x,y_1+y_2)}\]
This bilinear structure comes from interpreting $J^\wedge$ as $\text{Ext}^1(J,\G_m)$; then $P^\times$ is the universal extension of $J$ by $\G_m$, indexed by $J^\wedge$, and by duality vice versa as well.

Instead of doing Chabauty in this Poincar\'e torsor, we will look at a pullback of this torsor to a $\G_m$-torsor over $J_\Q$. Our first attempt is pulling back along the map $J_\Q$ to $J_\Q \times J^\wedge_\Q$ given as $(\id,\tr_c \circ f)$ where $f: J_\Q \to J^\wedge_\Q$ is a morphism of group schemes. We denote the pullback of $P^\times_\Q$ along this map by $T_\Q$, a $\G_m$-torsor over $J_\Q$. This $T_\Q$ has dimension $g+1$. The general idea of geometric quadratic Chabauty, is to work with the following diagram
\[\begin{tikzcd} % https://tikzcd.yichuanshen.de/#N4Igdg9gJgpgziAXAbVABwnAlgFyxMJZABgBoBGAXVJADcBDAGwFcYkQBhAfQB0eBFEAF9S6TLnyEU5CtTpNW7AFK8Bw0SAzY8BIgCZZNBizaIQKvvwAEfPAFt4VpQD0+AdxhQA5jFWCRYtqS+qTEcsaKZgAKrjz28OqBErrSoeEKpiAAKsJynj4IKKAAZgBOEHZIZCA4EEgALEYZ7HxZWIywwABWXABGQokgZRVVNLVIMvIm7D29g8OViJPjiAZTkSAAFHxYUKS2pVwAxjY8R1ilJ8UAlPPli401dUsBQ-cNY88AzK8LSF+fJBrRj0XowRhRcQ6KQgRgwYo4XJCIA
                                                & T_\Q \arrow[d] \arrow[rr]                   && P_\Q^\times \arrow[d]      \\
C_\Q \arrow[ru, "\widetilde{j_b}"] \arrow[r, "j_b"] & J_\Q \arrow[rr, "{(\id,\tr_c \circ f)}"] && J_\Q \times J^\wedge_\Q
\end{tikzcd}\]
where $\widetilde{j_b}$ is a lift of $j_b$. This lift will only exist if $j_b^* T$ is a trivial $\G_m$-torsor over $C_\Q$; for that, it turns out that we want $f$ to be an element of $\Hom^+(J_\Q,J^\wedge_\Q)_0$, the group of self dual homomorphisms of trace $0$ (where this trace comes from identification with the N\'eron-Severi group); if we do that, it turns out that $j_b^* T$ will correspond to a degree $0$ line bundle on $C_\Q$, and we only need to translate by a constant to make $j_b^* T$ trivial.

If $f$ itself is already $0$, then $T$ is trivial and this will give no further information, and in general that is the best we can do, as generically the rank of $\Hom^+(J_\Q,J^\wedge_\Q)$, also called the N\'eron-Severi rank $\rho$, is $1$. But in many interesting cases, this rank is bigger than $1$. Using the isomorphism $\lambda$, this rank is also the rank of a certain subgroup of the endomorphism ring of $J_\Q$, and it turns out a family of possible examples is given by modular curves; for example, normalisers of non-split Cartan curves $X_{\text{ns}}^+(\ell)$ have N\'eron-Severi rank equal to the genus, and according to the BSD conjecture Mordell-Weil rank at least equal to the genus. \todo{Bas, uiteindelijk heb ik er gewoon dit van gemaakt}.

In general, we can pick a basis $f_1,\dots,f_{\rho-1}$ of the trace $0$ subgroup of $\Hom^+(J_\Q,J^\wedge_\Q)$ and elements $c_1,\dots,c_{\rho-1} \in J_\Q^\wedge$ with $j_b^* (\id,\tr_{c_i} \circ f_i)^* P_{\Q}^\times$ trivial, and take the product of all the resulting pullbacks over $J_\Q$, to get a $\G_m^{\rho-1}$-torsor $T$ over $J_\Q$ that admits a morphism from $C_\Q$.

We then would like to intersect the rational points of $T_\Q$ with the $p$-adic points of $C_\Q$, mapped to $T_\Q$ under $\widetilde{j_b}$, inside the $p$-adic points of $T_\Q$. As in the case of classic Chabauty, one can conclude that the $p$-adic points of $T_\Q$ form a $p$-adic manifold of dimension $g+\rho-1$, but there is a problem with the rational points of $T_\Q$; these are in bijection with $\G_m(\Q)^{\rho-1} \times J_\Q(\Q)$. The latter is a finitely generated group of rank $r$, the Mordell-Weil rank, but the former is an infinitely generated group. One can upper bound the dimension of $\overline{T_\Q(\Q)}$ by $r + \rho -1$, but it is clear that this will not lead to an improvement to classic Chabauty.

% Spread out over Z, explain general process and some difficulties
To combat this problem, the crucial insight is that while $\Q^\times$ is infinitely generated, $\Z^\times$ is finite, so we set everything to work over $\Z$ instead of over $\Q$. Our curve is now a surface $C$, of relative dimension $1$ over $\Z$, proper, flat and regular with generic fiber $C_\Q$. We cannot expect $C$ to be smooth over $\Z$, we only ask that $C$ is smooth over $\Z[1/n]$ for some squarefree $n$ consisting of bad primes. We let $J$ be the N\'eron model over $\Z$ of the Jacobian of $C_\Q$, and $J^\wedge$ the N\'eron model of the dual of $J$. If we want to keep the essential biextension structure of the Poincar\'e torsor intact, we can only extend to $P \to J \times J^{\wedge 0}$ where $J^{\wedge 0}$ is the connected component of $J^\wedge$ containing $0$; the component group $J^\wedge/J^{\wedge 0}$ is only supported on $\Z/n\Z$, i.e. on the bad primes. We let $m\in \Z_{>0}$ be the annihilator of $J^\wedge/J^{\wedge 0}$. We can then make a similar diagram as before
\[\begin{tikzcd} % https://tikzcd.yichuanshen.de/#N4Igdg9gJgpgziAXAbVABwnAlgFyxMJZABgBoBGAXVJADcBDAGwFcYkQBhAfQB0eBFEAF9S6TLnyEU5CtTpNW7AFK8Bw0SAzY8BIgCZZNBizaIQKvvwAEfPAFt4VpQD0+AdxhQA5jFWCRYtqS+qTEcsaKZgAKrjz28OqBErrSoeEKpiAAKsJynj4IKKAAZgBOEHZIZCA4EEgALEYZ7HxZWIywwABWXABGQokgZRVVNLVIMvIm7D29g8OViJPjiAZTkSAAFHxYUKS2pVwAxjY8R1ilJ8UAlPPli401dUsBQ-cNY88AzK8LSF+fJBrRj0XowRhRcQ6KQgRgwYo4XJCIA
                                                & T \arrow[d] \arrow[rr]                   && P^\times \arrow[d]      \\
C \arrow[ru, "\widetilde{j_b}", dotted] \arrow[r, "j_b"] & J \arrow[rr, "{(\id,\cdot m \circ\tr_c \circ f)}"] && J \times J^{\wedge 0}
\end{tikzcd}\]
where this time $f$ is an element of $\Hom^+(J,J^\wedge)$ of trace $0$ and $c \in J^{\wedge}$ such that $j_b^* (\id,\tr_{c_i} \circ f_i)^* P_{\Q}^\times$ is trivial.

There is one problem: the lift of $j_b$ from $C$ to $T$ only exists if $j_b^* T$ is trivial over $C$. We know this is true when base changed over $\Q$, and over $\Q$ the lift exists and is unique up to the action of $\Q^\times$. For $q$ prime for which $C_{\F_q}$ has only one component, we can multiply a trivialising section over $C_\Q$ by a suitable power of $q$ to make it a trivialising section over $C_{\Z_{(q)}}$. However, we cannot always do this if $C_{\F_q}$ has multiple components.

So instead we cover $C^{\sm}$ with multiple opens $U_i$, obtained by removing for each $q$ dividing $n$ all but one irreducible components. As $C(\Z) = C^{\sm}(\Z)$, it is enough to compute $U_i(\Z)$ for every $U_i$. Then the map $j_{b,i}: U_i \to J$ does lift as in the following diagram:
\[\begin{tikzcd} % https://tikzcd.yichuanshen.de/#N4Igdg9gJgpgziAXAbVABwnAlgFyxMJZABgBoBGAXVJADcBDAGwFcYkQBhAfQB0eBFEAF9S6TLnyEU5CtTpNW7AFK8Bw0SAzY8BIgCZZNBizaIQKvvwAEfPAFt4VpQD0+AdxhQA5jFWCRYtqS+qTEcsaKZgAKrjz28OqBErrSoeEKpiAAKsJynj4IKKAAZgBOEHZIZCA4EEgALEYZ7HxZWIywwABWXABGQokgZRVVNLVIMvIm7D29g8OViJPjiAZTkSAAFHxYUKS2pVwAxjY8R1ilJ8UAlPPli401dUsBQ-cNY88AzK8LSF+fJBrRj0XowRhRcQ6KQgRgwYo4XJCIA
                                                & T \arrow[d] \arrow[rr]                   && P^\times \arrow[d]      \\
U_i \arrow[ru, "\widetilde{j_{b,i}}"] \arrow[r, "j_{b,i}"] & J \arrow[rr, "{(\id,\cdot m \circ\tr_c \circ f)}"] && J \times J^{\wedge 0}
\end{tikzcd}\]
and we can finalise the summary of quadratic Chabauty. Denote $T$ now for the product of all $\rho-1$ such pullbacks for $f$ ranging over a basis of the trace $0$ submodule of $\Hom^+(J,J^{\wedge})$. Taking a specific such $U$ with a lift $\widetilde{j_b}: U \to T$, for every prime $p$, the set $\widetilde{j_{b}}(U(\Z))$ is a subset of the intersection, inside the $p$-adic manifold $T(\Z_p)$, of $\widetilde{j_b}(U(\Z_p))$ and the closure $\overline{T(\Z)}$ of $T(\Z)$. As the relative dimension of $T$ over $\Z_p$ is $g+\rho-1$ (it is a $\G_m^{\rho-1}$-torsor over $J$), we can as in Section~\ref{section:smoothzppoints} see that $T(\Z_p)$ has dimension $g+\rho-1$; and as $T(\Z)$ is a $\{\pm 1\}^{\rho-1}$-torsor over the group $J(\Z)$ of rank $r$, it will turn out $\overline{T(\Z)}$ has dimension at most $r$. As $U(\Z_p)$ has dimension $1$, we can hope that this intersection is dimension $0$, and hence finite as $T(\Z_p)$ is compact, if $r < g + \rho-1$, hence we have an improvement over classical Chabauty.

This argument can be made explicit when looking at residue discs; in short, just like we could parametrise $J(\Z)_0$ with $\Z^r$ in Section~\ref{section:kappa} where the inclusion $\Z^r \to J(\Z_p)_0 \cong \Z_p^{g}$ is given by convergent power series, it turns out that for $t \in T(\F_p)$ that lift to $T(\Z)$, there is a map $\kappa: \Z^r \to T(\Z_p)_t \cong \Z_p^{g+\rho-1}$ such that $\im \kappa = \overline{T(\Z)_t}$ and $\kappa$ is given by convergent power series. This fact is a consequence of the biextension structure of $P^\wedge$; it allows us to quite explicitly move in the Poincar\'e torsor.

When the parameters at $t$ are chosen nicely, the first $g$ coming from $J$, it turns out that $\kappa_1,\dots,\kappa_g$ are linear modulo $p$, and $\kappa_{g+1},\dots,\kappa_{g+\rho-1}$ are quadratic modulo $p$. The fact that these are quadratic is in fact related to this being called quadratic Chabauty; it has to do with the bilinear structure on $P^\times$, that when restricted to the image of $(\id,\cdot m \circ\tr_c \circ f)$ is a quadratic object, as both of $\id$ and $m \circ\tr_c \circ f$ are linear maps. This is analogous to how a bilinear form gives a quadratic form when evaluated at the diagonal. One can also again find equations $g_1,\cdots,g_{r+\rho-2}$ for the the image of $U(\Z_p)$ in $T(\Z_p)_t$, which will again be linear modulo $p$.

We end with a proposition we already know; Proposition~\ref{prop:finedix} also holds in our case, and this once again can lead to giving an explicit upper bound for the cardinality of residue discs of $U(\Z)$ using finite precision calculations; repeating these calculations for the multiple opens $U$ and their $\F_p$-points, finally gives an upper bound for $C(\Z)$.

% Computations, and section 7 of the article (line bundles on C x C)
An important part of making the calculations work, is forming the map $\widetilde{j_b}: U \to T$. For this we need to be able to explicitly describe the trivialisation of the $\G_m$-torsor $j_b^* T$ restricted to $U$. Remember that $j_b^* T$ is also the pullback of $P^\times$ along the map $C \to J \times J^{\wedge 0}$, and this map factors through the diagonal map $C \to C\times C$. As described in Section~7 of the paper, it turns out that giving such a map $f: J \to J^{\wedge}$ and $c \in J^\wedge$ with $j_b^* T$ trivial over all opens $U$, is equivalent to giving a line bundle $\Lcal$ on $C \times C$ satisfying the following three properties: $\Lcal$ is rigidified on $\{b\} \times C_\Q$, the fibres of $\pr_2: (C \times C)_\Q \to C_\Q$ are degree $0$, and the pullback $\diag^* \Lcal$ is trivial on $C_\Q$. This turns the problem of describing a map $J \to J^\wedge$ in the sometimes more concrete problem of giving a line bundle on $C \times C$ satisfying some simple conditions.

These line bundles are crucial in doing actual computations. In the example in the Edixhoven-Lido paper, they use an involution of the curve to construct a correct line bundle. Right now, the focus is on doing a modular example, $X_0(73)^+$, a genus $2$ curve with endomorphism ring of rank $2$. Here, the extra information comes from the Hecke algebra working on the curve, and the problem at the time of writing lies in describing Hecke operators explicitly as correspondences on $C \times C$, and computations with these correspondences over $\Z$. 


\newpage
\bibliographystyle{alpha}
\addcontentsline{toc}{section}{References}
\bibliography{ref.bib}

\end{document}
